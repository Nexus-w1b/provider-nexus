<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Virza Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #00d4ff;
            --accent-2: #7b2cbf;
            --accent-3: #ff006e;
            --bg-deep: #030014;
            --bg-mid: #0a0a1f;
            --success: #00ff88;
            --warning: #ffbe0b;
            --danger: #ff006e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg-deep);
            color: #e0e7ff;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
        }

        .space-bg {
            position: fixed; inset: 0; z-index: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(123, 44, 191, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 0, 110, 0.05) 0%, transparent 70%),
                linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
        }

        .nebula {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            animation: nebulaPulse 10s ease-in-out infinite;
        }
        @keyframes nebulaPulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 0.5; }
        }

        .stars-layer { position: absolute; inset: 0; overflow: hidden; }
        .star { position: absolute; background: white; border-radius: 50%; }
        .star-small { animation: twinkle 3s ease-in-out infinite; }
        .star-medium { animation: twinkle 2s ease-in-out infinite; }
        .star-large { animation: twinkle 1.5s ease-in-out infinite; }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        .shooting-star {
            position: absolute;
            width: 150px;
            height: 2px;
            background: linear-gradient(90deg, white, transparent);
            animation: shoot 4s ease-in-out infinite;
            opacity: 0;
        }
        @keyframes shoot {
            0% { transform: translateX(0) translateY(0) rotate(-45deg); opacity: 0; }
            5% { opacity: 1; }
            15% { transform: translateX(-300px) translateY(300px) rotate(-45deg); opacity: 0; }
            100% { opacity: 0; }
        }

        .space-loading {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
            transition: opacity 0.5s ease-out;
        }
        .space-loading.hide { opacity: 0; pointer-events: none; }

        .spaceship-3d-wrap {
            perspective: 1200px;
            transform-style: preserve-3d;
        }

        .spaceship-3d {
            position: relative;
            width: 160px;
            height: 220px;
            transform-style: preserve-3d;
            animation: shipFloat3D 3s ease-in-out infinite, shipEnter 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes shipEnter {
            0% { 
                transform: translateY(200px) scale(0.3) rotateX(-20deg);
                opacity: 0;
            }
            60% {
                transform: translateY(-20px) scale(1.05) rotateX(5deg);
                opacity: 1;
            }
            100% { 
                transform: translateY(0) scale(1) rotateX(0deg);
                opacity: 1;
            }
        }

        @keyframes shipFloat3D {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            25% { transform: translateY(-12px) rotateY(8deg); }
            50% { transform: translateY(-6px) rotateY(0deg); }
            75% { transform: translateY(-15px) rotateY(-8deg); }
        }

        .rocket-body {
            position: absolute;
            left: 50%; top: 45px;
            transform: translateX(-50%);
            width: 55px; height: 120px;
            background: linear-gradient(90deg, 
                #1e293b 0%, #475569 20%, #94a3b8 40%,
                #e2e8f0 50%, #94a3b8 60%, #475569 80%, #1e293b 100%
            );
            border-radius: 50% 50% 20% 20% / 60% 60% 10% 10%;
            box-shadow: inset -8px 0 20px rgba(0,0,0,0.4), 0 15px 40px rgba(0, 212, 255, 0.25);
        }

        .rocket-nose {
            position: absolute;
            left: 50%; top: 0;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 28px solid transparent;
            border-right: 28px solid transparent;
            border-bottom: 50px solid #dc2626;
            filter: drop-shadow(0 -5px 15px rgba(220, 38, 38, 0.5));
        }
        .rocket-nose::before {
            content: '';
            position: absolute;
            top: 14px; left: -18px;
            width: 36px; height: 36px;
            background: linear-gradient(180deg, #fca5a5, #ef4444 50%, #dc2626);
            border-radius: 50% 50% 30% 30%;
        }

        .rocket-window {
            position: absolute;
            left: 50%; top: 70px;
            transform: translateX(-50%);
            width: 22px; height: 22px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), transparent 50%),
                        radial-gradient(circle, #00d4ff 0%, #0369a1 60%, #0c4a6e 100%);
            border-radius: 50%;
            border: 3px solid #334155;
            box-shadow: inset 0 0 10px rgba(0, 212, 255, 0.6), 0 0 20px rgba(0, 212, 255, 0.6);
            animation: windowGlow 2s ease-in-out infinite;
        }
        @keyframes windowGlow {
            0%, 100% { box-shadow: inset 0 0 10px rgba(0, 212, 255, 0.6), 0 0 20px rgba(0, 212, 255, 0.6); }
            50% { box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.8), 0 0 35px rgba(0, 212, 255, 0.8); }
        }

        .rocket-stripe {
            position: absolute;
            left: 50%; top: 110px;
            transform: translateX(-50%);
            width: 55px; height: 7px;
            background: linear-gradient(90deg, #1e293b, #dc2626 20%, #dc2626 80%, #1e293b);
            border-radius: 2px;
        }

        .fin-left, .fin-right {
            position: absolute;
            bottom: 25px;
        }
        .fin-left {
            left: 12px;
            width: 0; height: 0;
            border-right: 30px solid #b91c1c;
            border-top: 15px solid transparent;
            border-bottom: 40px solid transparent;
            transform: rotate(-10deg);
        }
        .fin-right {
            right: 12px;
            width: 0; height: 0;
            border-left: 30px solid #b91c1c;
            border-top: 15px solid transparent;
            border-bottom: 40px solid transparent;
            transform: rotate(10deg);
        }

        .rocket-engine {
            position: absolute;
            left: 50%; bottom: 0;
            transform: translateX(-50%);
            width: 38px; height: 22px;
            background: linear-gradient(180deg, #374151, #1f2937 50%, #111827 100%);
            border-radius: 0 0 40% 40%;
        }

        .flames-wrap {
            position: absolute;
            left: 50%; bottom: -55px;
            transform: translateX(-50%);
            display: flex; justify-content: center;
        }
        .flame {
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        }
        .flame-outer {
            width: 40px; height: 70px;
            background: linear-gradient(180deg, #f97316 0%, #ea580c 40%, #dc2626 70%, #991b1b 100%);
            box-shadow: 0 0 35px #dc2626, 0 0 70px #f97316;
            animation: flameOuter 0.1s ease-in-out infinite alternate;
        }
        .flame-mid {
            position: absolute; bottom: 5px;
            width: 26px; height: 50px;
            background: linear-gradient(180deg, #fde047 0%, #fbbf24 50%, #f97316 100%);
            box-shadow: 0 0 25px #fbbf24;
            animation: flameMid 0.08s ease-in-out infinite alternate;
        }
        .flame-core {
            position: absolute; bottom: 8px;
            width: 14px; height: 35px;
            background: linear-gradient(180deg, #fff 0%, #fef3c7 40%, #fde047 100%);
            box-shadow: 0 0 15px #fff;
            animation: flameCore 0.06s ease-in-out infinite alternate;
        }
        @keyframes flameOuter { 0% { transform: scaleY(1) scaleX(1); } 100% { transform: scaleY(1.15) scaleX(0.92); } }
        @keyframes flameMid { 0% { transform: scaleY(1); } 100% { transform: scaleY(1.12); } }
        @keyframes flameCore { 0% { transform: scaleY(1); } 100% { transform: scaleY(1.08); } }

        .flame-glow {
            position: absolute;
            left: 50%; bottom: -65px;
            transform: translateX(-50%);
            width: 100px; height: 100px;
            background: radial-gradient(ellipse at center top, rgba(251, 191, 36, 0.5) 0%, transparent 60%);
            animation: glowPulse 0.3s ease-in-out infinite alternate;
            pointer-events: none;
        }
        @keyframes glowPulse { 0% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Loading Text */
        .loading-text-box {
            margin-top: 90px;
            text-align: center;
            opacity: 0;
            animation: fadeInText 0.6s ease-out 0.8s forwards;
        }
        @keyframes fadeInText {
            from { opacity: 0; transform: translateY(25px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 0.25em;
            color: var(--accent);
            text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent);
            animation: titleGlow 2s ease-in-out infinite;
        }
        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent); }
            50% { text-shadow: 0 0 30px var(--accent), 0 0 60px var(--accent), 0 0 80px var(--accent); }
        }

        .loading-subtitle {
            font-size: 0.65rem;
            color: #64748b;
            margin-top: 0.5rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
        }

        .progress-bar-wrap {
            width: 200px;
            height: 4px;
            background: rgba(0, 212, 255, 0.15);
            border-radius: 2px;
            margin: 1.25rem auto;
            overflow: hidden;
            border: 1px solid rgba(0, 212, 255, 0.25);
            opacity: 0;
            animation: fadeInText 0.6s ease-out 1s forwards;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            border-radius: 2px;
            animation: progressAnim 3s ease-out forwards;
            box-shadow: 0 0 12px var(--accent);
        }
        @keyframes progressAnim {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .status-msg-box {
            margin-top: 1rem;
            height: 22px;
            opacity: 0;
            animation: fadeInText 0.6s ease-out 1.2s forwards;
        }
        .status-msg {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            color: var(--accent);
            text-align: center;
            opacity: 0;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }
        .status-msg.show { animation: statusPop 0.3s ease-out forwards; }
        @keyframes statusPop {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-screen {
            position: fixed; inset: 0; z-index: 100;
            display: none; align-items: center; justify-content: center; padding: 1rem;
            background: linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
        }

        .station-panel {
            position: relative;
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.95), rgba(3, 0, 20, 0.98));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 1.25rem;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.1);
            overflow: hidden;
        }

        .station-panel::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), var(--accent), transparent);
        }

        .corner-deco {
            position: absolute;
            width: 22px; height: 22px;
            border: 2px solid var(--accent);
            opacity: 0.4;
        }
        .corner-deco.tl { top: 8px; left: 8px; border-right: none; border-bottom: none; }
        .corner-deco.tr { top: 8px; right: 8px; border-left: none; border-bottom: none; }
        .corner-deco.bl { bottom: 8px; left: 8px; border-right: none; border-top: none; }
        .corner-deco.br { bottom: 8px; right: 8px; border-left: none; border-top: none; }

        .station-logo {
            width: 55px; height: 55px;
            margin: 0 auto 1rem;
            position: relative;
        }
        .station-logo-inner {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.4);
            animation: logoSpin 15s linear infinite;
        }
        @keyframes logoSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .station-logo i {
            font-size: 1.4rem;
            color: white;
            animation: logoSpin 15s linear infinite reverse;
        }
        .station-logo-ring {
            position: absolute; inset: -6px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0.4;
            animation: ringPulse 2s ease-in-out infinite;
        }
        @keyframes ringPulse {
            0%, 100% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.1); opacity: 0.2; }
        }

        .station-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            text-align: center;
            letter-spacing: 0.12em;
            margin-bottom: 0.15rem;
        }
        .station-title span { color: var(--accent); }

        .station-subtitle {
            font-size: 0.55rem;
            text-align: center;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.35em;
            margin-bottom: 1.5rem;
        }

        .input-group {
            position: relative;
            margin-bottom: 0.75rem;
        }
        .input-group i {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
            opacity: 0.7;
        }
        .input-group input {
            width: 100%;
            padding: 0.7rem 0.8rem 0.7rem 2.4rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.6rem;
            color: white;
            font-size: 0.8rem;
            outline: none;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
        }
        .input-group input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }
        .input-group input::placeholder { color: #475569; }

        .btn-primary {
            width: 100%;
            padding: 0.7rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border: none;
            border-radius: 0.6rem;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 35px rgba(0, 212, 255, 0.4); }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            width: 100%;
            padding: 0.6rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.25);
            border-radius: 0.6rem;
            color: var(--accent);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Rajdhani', sans-serif;
        }
        .btn-secondary:hover { background: rgba(0, 212, 255, 0.15); }

        .btn-anonymous {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.25);
            color: var(--success);
        }
        .btn-anonymous:hover { background: rgba(0, 255, 136, 0.15); }

        .divider {
            display: flex;
            align-items: center;
            margin: 0.85rem 0;
        }
        .divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.25), transparent);
        }
        .divider-text {
            padding: 0 0.8rem;
            font-size: 0.55rem;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 0.75rem;
        }
        .auth-toggle button {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.65rem;
            cursor: pointer;
        }

        .main-ui {
            position: relative;
            z-index: 10;
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .header {
            height: 55px;
            background: rgba(3, 0, 20, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 212, 255, 0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0.8rem;
            position: relative;
            z-index: 50;
        }

        .header::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .header-left { display: flex; align-items: center; gap: 0.6rem; }
        .back-btn {
            width: 32px; height: 32px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.5rem;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            cursor: pointer;
        }
        .back-btn.show { display: flex; }

        .status-indicator { display: flex; flex-direction: column; gap: 0.1rem; }
        .status-row { display: flex; align-items: center; gap: 0.3rem; }
        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
        }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.connecting { background: var(--warning); box-shadow: 0 0 8px var(--warning); animation: dotBlink 1s infinite; }
        @keyframes dotBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .status-text {
            font-size: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }
        .time-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .header-right { display: flex; align-items: center; gap: 0.4rem; }
        .header-badge {
            padding: 0.2rem 0.45rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.8rem;
            font-size: 0.5rem;
            font-weight: 600;
            color: var(--accent);
        }
        .avatar-btn {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }
        .settings-btn {
            width: 32px; height: 32px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            cursor: pointer;
        }

        .gps-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-size: 0.5rem;
            text-transform: uppercase;
        }
        .gps-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            background: #4a5568;
            transition: all 0.3s;
        }
        .gps-dot.active { background: var(--success); box-shadow: 0 0 6px var(--success); animation: gpsPulse 2s infinite; }
        .gps-dot.inactive { background: var(--danger); }
        @keyframes gpsPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .lobby-view {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            padding: 0.8rem;
        }
        .lobby-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0.5rem 0;
        }

        .welcome-section {
            margin-bottom: 1rem;
            text-align: center;
        }
        @media (min-width: 768px) { .welcome-section { text-align: left; } }

        .welcome-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        @media (min-width: 768px) { .welcome-title { font-size: 1.5rem; } }
        .welcome-title span {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-top: 0.5rem;
            justify-content: center;
        }
        @media (min-width: 768px) { .status-badges { justify-content: flex-start; } }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.8rem;
            font-size: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-success {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.25);
        }
        .badge-info {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent);
            border: 1px solid rgba(0, 212, 255, 0.25);
        }
        .badge-warning {
            background: rgba(255, 190, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 190, 11, 0.25);
        }

        .search-section {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 0.7rem 0.8rem 0.7rem 2.3rem;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.6rem;
            color: white;
            font-size: 0.75rem;
            outline: none;
            font-family: 'Rajdhani', sans-serif;
        }
        .search-input:focus { border-color: var(--accent); }
        .search-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
            opacity: 0.6;
        }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.55rem;
            padding-bottom: 1.25rem;
        }
        @media (min-width: 480px) { .portal-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .portal-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1024px) { .portal-grid { grid-template-columns: repeat(5, 1fr); gap: 0.75rem; } }

        .portal-card {
            position: relative;
            padding: 0.75rem;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.7), rgba(3, 0, 20, 0.85));
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s;
        }
        .portal-card:hover {
            transform: translateY(-2px);
            border-color: rgba(0, 212, 255, 0.35);
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.1);
        }
        .portal-card:active { transform: scale(0.97); }

        .portal-icon {
            width: 35px;
            height: 35px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            margin-bottom: 0.35rem;
        }
        .portal-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.55rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .portal-desc {
            font-size: 0.45rem;
            color: #64748b;
            margin-top: 0.15rem;
            text-transform: uppercase;
        }

        .workspace-view {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
        }
        .workspace-view.active { display: flex; }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(3, 0, 20, 0.4);
        }

        .chat-header {
            padding: 0.55rem 0.8rem;
            background: rgba(0, 0, 0, 0.25);
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-header-left { display: flex; align-items: center; gap: 0.45rem; }
        .chat-portal-icon {
            width: 28px;
            height: 28px;
            border-radius: 0.35rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .chat-portal-name { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: 700; }
        .chat-portal-desc { font-size: 0.5rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em; }

        .mode-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.35);
            border-radius: 0.8rem;
            font-size: 0.5rem;
            font-weight: 600;
        }
        .mode-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: modePulse 2s ease-in-out infinite;
        }
        @keyframes modePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.55rem;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .message {
            max-width: 85%;
            padding: 0.55rem 0.75rem;
            border-radius: 0.75rem;
            animation: msgSlide 0.2s ease-out;
        }
        @keyframes msgSlide {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 0.75rem 0.75rem 0.15rem 0.75rem;
        }
        .message-ai {
            align-self: flex-start;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 0.75rem 0.75rem 0.75rem 0.15rem;
        }
        .message-sender {
            font-size: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: 0.15rem;
        }
        .message-text { font-size: 0.7rem; line-height: 1.4; }

        .typing-indicator { display: flex; gap: 0.15rem; padding: 0.35rem 0; }
        .typing-indicator span {
            width: 4px; height: 4px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input-area {
            padding: 0.55rem;
            background: linear-gradient(to top, rgba(3, 0, 20, 0.95), rgba(3, 0, 20, 0.85));
            border-top: 1px solid rgba(0, 212, 255, 0.08);
        }

        .chat-input-row { display: flex; align-items: flex-end; gap: 0.35rem; }

        .attachment-btn {
            width: 35px;
            height: 35px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.35rem;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .attachment-btn.active {
            background: rgba(0, 255, 136, 0.12);
            border-color: rgba(0, 255, 136, 0.25);
            color: var(--success);
        }

        .attachment-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 0.35rem;
            background: rgba(10, 10, 31, 0.98);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.25rem;
            display: none;
            flex-direction: column;
            gap: 0.1rem;
            min-width: 140px;
            box-shadow: 0 -6px 25px rgba(0, 0, 0, 0.4);
            z-index: 100;
        }
        .attachment-menu.show { display: flex; animation: slideUp 0.15s ease-out; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .attachment-menu button {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.55rem;
            background: transparent;
            border: none;
            border-radius: 0.35rem;
            color: #e0e7ff;
            font-size: 0.65rem;
            cursor: pointer;
            text-align: left;
            font-family: 'Rajdhani', sans-serif;
        }
        .attachment-menu button:hover { background: rgba(0, 212, 255, 0.1); }

        .chat-textarea {
            flex: 1;
            padding: 0.55rem;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.7rem;
            outline: none;
            resize: none;
            max-height: 80px;
            font-family: 'Rajdhani', sans-serif;
        }
        .chat-textarea:focus { border-color: var(--accent); }

        .send-btn {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border: none;
            border-radius: 0.35rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.25);
        }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .speed-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            margin-top: 0.35rem;
            padding-top: 0.35rem;
            border-top: 1px solid rgba(0, 212, 255, 0.06);
        }
        .speed-label {
            font-size: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
        }
        .speed-btn {
            padding: 0.2rem 0.45rem;
            border-radius: 0.8rem;
            font-size: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
        }
        .speed-btn.fast { color: var(--success); border-color: rgba(0, 255, 136, 0.25); }
        .speed-btn.balanced { color: var(--warning); border-color: rgba(255, 190, 11, 0.25); }
        .speed-btn.quality { color: var(--danger); border-color: rgba(255, 0, 110, 0.25); }
        .speed-btn.inactive { opacity: 0.5; }
        .speed-btn.active { box-shadow: 0 0 10px currentColor; }

        .sidebar {
            position: fixed;
            inset-y: 0;
            right: 0;
            width: 280px;
            max-width: 82vw;
            background: linear-gradient(180deg, rgba(10, 10, 31, 0.98), rgba(3, 0, 20, 0.99));
            border-left: 1px solid rgba(0, 212, 255, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }

        .sidebar-header {
            padding: 0.85rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        .sidebar-title span { color: var(--accent); }
        .sidebar-close {
            width: 26px;
            height: 26px;
            background: rgba(0, 212, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .sidebar-section {
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 0.5rem;
        }
        .sidebar-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .sidebar-section-title i { color: var(--accent); }

        .key-pool-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.35rem;
            font-size: 0.55rem;
        }
        .key-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.15rem; }
        .key-dot {
            aspect-ratio: 1;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .key-dot.active { background: var(--success); box-shadow: 0 0 4px var(--success); }
        .key-dot.exhausted { background: var(--danger); opacity: 0.5; }
        .key-dot.standby { background: rgba(0, 212, 255, 0.3); }

        .proxy-actions { display: flex; flex-direction: column; gap: 0.25rem; }
        .proxy-btn {
            padding: 0.45rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.35rem;
            color: var(--accent);
            font-size: 0.55rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            font-family: 'Rajdhani', sans-serif;
        }
        .proxy-btn.tor.active { background: rgba(123, 44, 191, 0.15); color: var(--accent-2); }

        .quick-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.35rem; }
        .stat-card {
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.08);
            border-radius: 0.35rem;
            text-align: center;
        }
        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--accent);
        }
        .stat-label {
            font-size: 0.45rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .sidebar-actions { display: flex; flex-direction: column; gap: 0.25rem; }
        .action-btn {
            padding: 0.5rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.18);
            border-radius: 0.35rem;
            color: var(--accent);
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            font-family: 'Rajdhani', sans-serif;
        }
        .action-btn.danger {
            background: rgba(255, 0, 110, 0.1);
            border-color: rgba(255, 0, 110, 0.18);
            color: var(--danger);
        }

        .sidebar-footer { padding: 0.75rem; border-top: 1px solid rgba(0, 212, 255, 0.08); }
        .logout-btn {
            width: 100%;
            padding: 0.55rem;
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.18);
            border-radius: 0.35rem;
            color: var(--danger);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
         }

        .history-panel {
            position: fixed;
            inset: 0;
            z-index: 300;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0.8rem;
        }
        .history-panel.open { display: flex; }
        .history-content {
            width: 100%;
            max-width: 400px;
            max-height: 70vh;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.98), rgba(3, 0, 20, 0.99));
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.75rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .history-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-list { flex: 1; overflow-y: auto; padding: 0.75rem; }
        .history-item {
            padding: 0.55rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.08);
            border-radius: 0.35rem;
            margin-bottom: 0.35rem;
            cursor: pointer;
        }
        .history-item:hover { background: rgba(0, 212, 255, 0.08); }
        .history-meta { display: flex; justify-content: space-between; margin-bottom: 0.15rem; font-size: 0.5rem; }
        .history-portal { font-weight: 700; text-transform: uppercase; color: var(--accent); }
        .history-time { color: #64748b; }
        .history-prompt {
            font-size: 0.65rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-panel {
            position: fixed;
            inset: 0;
            z-index: 350;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0.8rem;
        }
        .contact-panel.open { display: flex; }
        .contact-content {
            width: 100%;
            max-width: 380px;
            padding: 1.25rem;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.98), rgba(3, 0, 20, 0.99));
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.75rem;
        }
        .contact-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }
        .contact-header h3 { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.85rem; }
        .contact-options { display: flex; flex-direction: column; gap: 0.65rem; }
        .contact-btn {
            padding: 0.85rem;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.6rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.65rem;
            text-decoration: none;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
        }
        .contact-btn:hover { background: rgba(0, 212, 255, 0.12); transform: translateY(-2px); }
        .contact-btn i { font-size: 1.1rem; width: 22px; text-align: center; }
        .contact-btn.email i { color: var(--accent); }
        .contact-btn.whatsapp i { color: #25D366; }
        .contact-btn-info { flex: 1; }
        .contact-btn-label { font-weight: 700; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.1em; }
        .contact-btn-desc { font-size: 0.6rem; color: #64748b; margin-top: 0.15rem; }

        .global-panel {
            position: fixed;
            inset: 0;
            z-index: 360;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0.8rem;
        }
        .global-panel.open { display: flex; }
        .global-content {
            width: 100%;
            max-width: 450px;
            height: 75vh;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.98), rgba(3, 0, 20, 0.99));
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .global-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .global-chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .global-msg {
            padding: 0.5rem 0.65rem;
            border-radius: 0.5rem;
            max-width: 80%;
            font-size: 0.7rem;
        }
        .global-msg.self {
            align-self: flex-end;
            background: rgba(0, 212, 255, 0.15);
        }
        .global-msg.other {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
        }
        .global-input-area {
            padding: 0.55rem;
            border-top: 1px solid rgba(0, 212, 255, 0.08);
            display: flex;
            gap: 0.4rem;
        }
        .global-input {
            flex: 1;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.12);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.7rem;
            outline: none;
            font-family: 'Rajdhani', sans-serif;
        }

        .toast {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.55rem 1.1rem;
            border-radius: 0.8rem;
            font-size: 0.65rem;
            font-weight: 600;
            z-index: 5000;
            animation: toastIn 0.2s ease-out;
        }
        .toast.success { background: rgba(0, 255, 136, 0.95); color: #000; }
        .toast.error { background: rgba(255, 0, 110, 0.95); color: #fff; }
        .toast.warning { background: rgba(255, 190, 11, 0.95); color: #000; }
        .toast.info { background: rgba(0, 212, 255, 0.95); color: #000; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(12px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div class="space-bg">
        <div class="stars-layer" id="starsLayer"></div>
        <div class="nebula" style="width: 350px; height: 350px; background: rgba(123, 44, 191, 0.18); top: 12%; left: 6%;"></div>
        <div class="nebula" style="width: 280px; height: 280px; background: rgba(0, 212, 255, 0.12); bottom: 18%; right: 8%; animation-delay: 3s;"></div>
        <div class="shooting-star" style="top: 22%; right: 18%;"></div>
        <div class="shooting-star" style="top: 45%; right: 35%; animation-delay: 2s;"></div>
        <div class="shooting-star" style="top: 65%; right: 12%; animation-delay: 4s;"></div>
    </div>

    <div id="loadingScreen" class="space-loading">
        <div class="stars-layer" id="loadingStars"></div>
        
        <div class="spaceship-3d-wrap">
            <div class="spaceship-3d">
                <div class="rocket-nose"></div>
                <div class="rocket-body">
                    <div class="rocket-window"></div>
                    <div class="rocket-stripe"></div>
                </div>
                <div class="fin-left"></div>
                <div class="fin-right"></div>
                <div class="rocket-engine"></div>
                <div class="flames-wrap">
                    <div class="flame flame-outer"></div>
                    <div class="flame flame-mid"></div>
                    <div class="flame flame-core"></div>
                </div>
                <div class="flame-glow"></div>
            </div>
        </div>
        
        <div class="loading-text-box">
            <div class="loading-title">NEXUS</div>
            <div class="loading-subtitle">Virza Portal System</div>
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="status-msg-box">
                <div class="status-msg" id="status1">Loading Core Systems...</div>
                <div class="status-msg" id="status2">Establishing Neural Link...</div>
                <div class="status-msg" id="status3">Portal Gateway Ready</div>
            </div>
        </div>
    </div>

    <div id="authScreen" class="auth-screen">
        <div class="station-panel">
            <div class="corner-deco tl"></div>
            <div class="corner-deco tr"></div>
            <div class="corner-deco bl"></div>
            <div class="corner-deco br"></div>
            
            <div class="station-logo">
                <div class="station-logo-ring"></div>
                <div class="station-logo-inner"><i class="fa-solid fa-rocket"></i></div>
            </div>
            
            <h1 class="station-title">NEXUS <span>PORT</span></h1>
            <p class="station-subtitle">Virza Portal Access Terminal</p>
            
            <div class="input-group">
                <i class="fa-solid fa-envelope"></i>
                <input type="email" id="emailInput" placeholder="Email Address">
            </div>
            <div class="input-group">
                <i class="fa-solid fa-lock"></i>
                <input type="password" id="passInput" placeholder="Security Code">
            </div>
            
            <button class="btn-primary" onclick="handleAuth()" id="authBtn">Initialize Connection</button>
            
            <div class="divider">
                <div class="divider-line"></div>
                <span class="divider-text">or</span>
                <div class="divider-line"></div>
            </div>
            
            <button class="btn-secondary" onclick="handleGoogle()">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Google
            </button>
            <button class="btn-secondary btn-anonymous" onclick="handleAnonLogin()"><i class="fa-solid fa-user-secret"></i> akun guest</button>
            
            <div class="auth-toggle">
                <button onclick="toggleAuthMode()" id="authToggleBtn">belum punya akun? daftar</button>
            </div>
        </div>
    </div>
    et i=0;i<n;i++){
                const s = document.createElement('div');
    <div id="mainUI" class="main-ui">
        <header class="header">
            <div class="header-left">
                <button class="back-btn" id="backBtn" onclick="exitPortal()"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="status-indicator">
                    <div class="status-row">
                        <div class="status-dot connecting" id="statusDot"></div>
                        <span class="status-text" id="statusText">CONNECTING</span>
                    </div>
                    <div class="time-display" id="timeDisplay">00:00:00</div>
                </div>
            </div>
            <div class="header-right">
                <div class="gps-indicator">
                    <div class="gps-dot" id="gpsDot"></div>
                    <span id="gpsText">GPS</span>
                </div>
                <div class="header-badge" id="keyBadge"> Keys Active</div>
                <div class="avatar-btn" onclick="toggleSidebar()" id="avatarBtn">V</div>
                <button class="settings-btn" onclick="toggleSidebar()"><i class="fa-solid fa-sliders"></i></button>
            </div>
        </header>

        <main class="main-content">
            <div id="lobbyView" class="lobby-view no-scrollbar">
                <div class="lobby-content">
                    <div class="welcome-section">
                        <h2 class="welcome-title">Welcome, <span id="userName">NPC</span></h2>
                        <div class="status-badges">
                            <span class="badge badge-success"><i class="fa-solid fa-circle-check"></i> Nexus Ready</span>
                            <span class="badge badge-info"><i class="fa-solid fa-key"></i> <span id="activeKeys">2</span> Keys</span>
                            <span class="badge badge-warning" id="proxyBadge"><i class="fa-solid fa-network-wired"></i> <span id="proxyCount">0</span> Proxies</span>
                        </div>
                    </div>
                    <div class="search-section">
                        <i class="fa-solid fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search portals by name or function..." oninput="filterPortals()">
                    </div>
                    <div class="portal-grid" id="portalGrid"></div>
                </div>
            </div>

            <div id="workspaceView" class="workspace-view">
                <div class="chat-panel">
                    <div class="chat-header">
                        <div class="chat-header-left">
                            <div class="chat-portal-icon" id="chatPortalIcon"><i class="fa-solid fa-robot"></i></div>
                            <div>
                                <div class="chat-portal-name" id="chatPortalName">Smart AI</div>
                                <div class="chat-portal-desc" id="chatPortalDesc">Chat Active</div>
                            </div>
                        </div>
                        <div class="mode-badge" id="modeBadge"><div class="mode-dot" style="background:var(--success)"></div><span>Flash</span></div>
                    </div>
                    <div class="chat-box no-scrollbar" id="chatBox">
                        <div class="message message-ai">
                            <div class="message-sender">Nexus AI</div>
                            <div class="message-text">SIAP MELAYANI,ADA YANG PERLU DI BANTU?</div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-row">
                            <div class="attachment-btn" id="attachBtn" onclick="toggleAttach()">
                                <i class="fa-solid fa-plus"></i>
                                <div class="attachment-menu" id="attachMenu">
                                    <button onclick="addAttach('image')"><i class="fa-solid fa-image" style="color:var(--success)"></i><span>Photo</span></button>
                                    <button onclick="addAttach('document')"><i class="fa-solid fa-file-lines" style="color:var(--accent)"></i><span>TXT File</span></button>
                                </div>
                            </div>
                            <textarea class="chat-textarea" id="chatInput" placeholder="Type command..." rows="1" oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
                            <button class="send-btn" id="sendBtn" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        <div class="speed-row">
                            <span class="speed-label">Speed:</span>
                            <button class="speed-btn fast active" data-mode="fast" onclick="setSpeed('fast')">Fast</button>
                            <button class="speed-btn inactive" data-mode="balanced" onclick="setSpeed('balanced')">Balanced</button>
                            <button class="speed-btn inactive" data-mode="quality" onclick="setSpeed('quality')">Quality</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Vault <span>Control</span></h3>
            <button class="sidebar-close" onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="sidebar-content no-scrollbar">
            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-microchip"></i> Nexus AI</div>
                <select class="search-input" id="modelSel" onchange="updateMode()" style="margin-bottom:0.5rem">
                    <option value="gemini-1.5-flash">1.5 Flash</option>
                    <option value="gemini-1.5-flash-8b">1.5 Flash-8B</option>
                    <option value="gemini-1.5-pro">1.5 Pro</option>
                </select>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-key"></i> API Key Pools</div>
                <div class="key-pool-info"><span>Active: <strong id="activeKeyNum">2</strong>/2</span></div>
                <div class="key-grid" id="keyGrid"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-network-wired"></i> Proxy Network</div>
                <div class="proxy-actions">
                    <button class="proxy-btn" onclick="fetchProxies()"><i class="fa-solid fa-rotate"></i> Refresh (<span id="proxyNum">0</span>)</button>
                    <button class="proxy-btn" id="torBtn" onclick="toggleTor()"><i class="fa-solid fa-user-secret"></i> Incognito: OFF</button>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-chart-line"></i> Stats</div>
                <div class="quick-stats">
                    <div class="stat-card"><div class="stat-value" id="msgNum">0</div><div class="stat-label">Messages</div></div>
                    <div class="stat-card"><div class="stat-value" id="reqNum">0</div><div class="stat-label">Requests</div></div>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="action-btn" onclick="openGlobal()"><i class="fa-solid fa-users"></i> Global Lounge</button>
                <button class="action-btn" onclick="openHist()"><i class="fa-solid fa-clock-rotate-left"></i> History</button>
                <button class="action-btn" onclick="clearChat()"><i class="fa-solid fa-broom"></i> Clear Chat</button>
                <button class="action-btn" onclick="openContact()"><i class="fa-solid fa-envelope"></i> Contact Dev</button>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> dashboard</button>
        </div>
    </aside>

    <div class="history-panel" id="histPanel">
        <div class="history-content">
            <div class="history-header">
                <h3 style="font-family:'Orbitron',sans-serif;font-weight:700">History</h3>
                <button class="sidebar-close" onclick="closeHist()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="history-list no-scrollbar" id="histList"><p style="text-align:center;color:#64748b;padding:1.5rem">No history </p></div>
        </div>
    </div>

    <div class="contact-panel" id="contactPanel">
        <div class="contact-content">
            <div class="contact-header">
                <h3>Contact Developer</h3>
                <button class="sidebar-close" onclick="closeContact()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="contact-options">
                <a href="mailto:visi4ura@gmail.com?subject=Virza%20Nexus%20Support&body=Hello%20Developer%2C%0A%0AI%20need%20assistance%20with%20Virza%20Nexus.%0A%0A%5BPlease%20describe%20your%20issue%5D%0A%0ABest%20regards" class="contact-btn email">
                    <i class="fa-solid fa-envelope"></i>
                    <div class="contact-btn-info">
                        <div class="contact-btn-label">Email Support</div>
                        <div class="contact-btn-desc">visi4ura@gmail.com</div>
                    </div>
                </a>
                <a href="https://wa.me/6285715818953?text=Hello%20Developer%2C%0A%0AI%20am%20using%20Virza%20Nexus%20and%20need%20assistance.%0A%0A%5BPlease%20describe%20your%20issue%5D" target="_blank" class="contact-btn whatsapp">
                    <i class="fa-brands fa-whatsapp"></i>
                    <div class="contact-btn-info">
                        <div class="contact-btn-label">WhatsApp</div>
                        <div class="contact-btn-desc">+62 882-2587-9928</div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <div class="global-panel" id="globalPanel">
        <div class="global-content">
            <div class="global-header">
                <h3 style="font-family:'Orbitron',sans-serif;font-weight:700;color:var(--accent)"><i class="fa-solid fa-users" style="margin-right:0.5rem"></i>Global Lounge</h3>
                <button class="sidebar-close" onclick="closeGlobal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="global-chat-box no-scrollbar" id="globalBox"></div>
            <div class="global-input-area">
                <input type="text" class="global-input" id="globalInput" placeholder="Chat with others..." onkeydown="if(event.key==='Enter')sendGlobal()">
                <button class="send-btn" onclick="sendGlobal()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept="image/*,.txt" onchange="handleFile(event)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const fbConfig = {
            apiKey: "AIzaSyBK-MehTTzURY5jT5stH363Y5_WE4iy-XA",
            authDomain: "volca-tools.firebaseapp.com",
            projectId: "volca-tools",
            storageBucket: "volca-tools.firebasestorage.app",
            messagingSenderId: "262525907487",
            appId: "1:262525907487:web:4abc37fa3b583223569b2a"
        };

        const app = initializeApp(fbConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const prov = new GoogleAuthProvider();

        let isLogin = true;
        let user = null;
        let attach = null;
        let speed = 'fast';
        let keyIdx = 0;
        let exhausted = new Set();
        let proxies = [];
        let tor = false;
        let msgs = 0, reqs = 0;
        let activePortal = 'General';

        const KEYS = [
            "AIzaSyDkUSuxeVnUHUzkANYePkrJMOTeC8Gx71E",
            "AIzaSyAAtWkmgIQBhJIbsuQAx_y4l_MB2OX1UGs"
        ];

        const SPEED_CFG = {
            fast: { temperature: 0.5, maxOutputTokens: 1024 },
            balanced: { temperature: 0.7, maxOutputTokens: 2048 },
            quality: { temperature: 0.9, maxOutputTokens: 4096 }
        };

        const portals = [
            {id:'smart',name:'Smart AI',ic:'fa-brain',c:'#34d399',desc:'General chat'},
            {id:'code',name:'Architect',ic:'fa-code',c:'#818cf8',desc:'Code builder'},
            {id:'img',name:'Image HD',ic:'fa-image',c:'#f472b6',desc:'Create visuals'},
            {id:'vision',name:'Vision Pro',ic:'fa-eye',c:'#fbbf24',desc:'Analyze images'},
            {id:'web',name:'Web Weaver',ic:'fa-globe',c:'#60a5fa',desc:'Build websites'},
            {id:'cyber',name:'Cyber Guard',ic:'fa-shield',c:'#f87171',desc:'Security'},
            {id:'math',name:'Quantum',ic:'fa-calculator',c:'#a78bfa',desc:'Math & logic'},
            {id:'seo',name:'SEO Master',ic:'fa-magnifying-glass',c:'#2dd4bf',desc:'Optimize'},
            {id:'data',name:'Data Miner',ic:'fa-database',c:'#94a3b8',desc:'Data analysis'},
            {id:'social',name:'Social Ads',ic:'fa-hashtag',c:'#fb7185',desc:'Marketing'},
            {id:'vid',name:'Motion AI',ic:'fa-film',c:'#fb923c',desc:'Video ideas'},
            {id:'audio',name:'Sonic Wave',ic:'fa-music',c:'#4ade80',desc:'Audio'},
            {id:'logo',name:'Brand AI',ic:'fa-pen-nib',c:'#e879f9',desc:'Branding'},
            {id:'lang',name:'Polyglot',ic:'fa-language',c:'#818cf8',desc:'Translate'},
            {id:'bug',name:'Debug Sys',ic:'fa-bug',c:'#ef4444',desc:'Fix bugs'},
            {id:'cloud',name:'Cloud Drive',ic:'fa-cloud',c:'#38bdf8',desc:'Cloud'},
            {id:'sec',name:'Vault Pro',ic:'fa-lock',c:'#fbbf24',desc:'Security'},
            {id:'write',name:'Ghost Writer',ic:'fa-book',c:'#c084fc',desc:'Content'},
            {id:'game',name:'Game Dev',ic:'fa-gamepad',c:'#f472b6',desc:'Games'},
            {id:'law',name:'Law Logic',ic:'fa-gavel',c:'#fca5a5',desc:'Legal'},
            {id:'health',name:'Medi AI',ic:'fa-heart-pulse',c:'#ef4444',desc:'Health'},
            {id:'finance',name:'Fin AI',ic:'fa-chart-pie',c:'#22c55e',desc:'Finance'},
            {id:'edu',name:'Edu AI',ic:'fa-graduation-cap',c:'#3b82f6',desc:'Learning'},
            {id:'travel',name:'Travel AI',ic:'fa-plane',c:'#06b6d4',desc:'Trips'},
            {id:'recipe',name:'Chef AI',ic:'fa-utensils',c:'#f97316',desc:'Recipes'}
        ];

        function makeStars(el, n) {
            for(ls.className = 'star star-'+['small','medium','large'][Math.floor(Math.random()*3)];
                s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${Math.random()*2+1}px;animation-delay:${Math.random()*3}s`;
                el.appendChild(s);
            }
        }

        function runLoad() {
            const st = ['status1','status2','status3'];
            let i=0;
            function next() {
                if(i>0) document.getElementById(st[i-1]).classList.remove('show');
                if(i<st.length){ document.getElementById(st[i]).classList.add('show'); i++; setTimeout(next,500); }
            }
            setTimeout(next,1000);
            setTimeout(()=>{
                document.getElementById('loadingScreen').classList.add('hide');
                document.getElementById('authScreen').style.display='flex';
            },3000);
        }

        makeStars(document.getElementById('starsLayer'),120);
        makeStars(document.getElementById('loadingStars'),70);
        runLoad();

        function updKeys() {
            const act = KEYS.length - exhausted.size;
            document.getElementById('activeKeyNum').textContent = act;
            document.getElementById('activeKeys').textContent = act;
            document.getElementById('keyBadge').textContent = act+' Keys';
            document.getElementById('keyGrid').innerHTML = KEYS.map((_,i)=>{
                let c = 'key-dot standby';
                if(i===keyIdx&&!exhausted.has(i)) c='key-dot active';
                else if(exhausted.has(i)) c='key-dot exhausted';
                return `<div class="${c}"></div>`;
            }).join('');
        }
        updKeys();

        function getKey() {
            let a=0;
            while(a<KEYS.length){
                if(!exhausted.has(keyIdx)){ updKeys(); return {k:KEYS[keyIdx],i:keyIdx}; }
                keyIdx = (keyIdx+1)%KEYS.length;
                a++;
            }
            toast('apikey nya limit nih. tunggu 60s ya ...','warning');
            return null;
        }

        function markKey(i) {
            exhausted.add(i);
            keyIdx = (i+1)%KEYS.length;
            updKeys();
            toast('Key '+ (i+1) +' limited','warning');
        }

        function toast(m,t='success') {
            const e=document.querySelector('.toast'); if(e) e.remove();
            const d=document.createElement('div'); d.className='toast '+t; d.textContent=m; document.body.appendChild(d);
            setTimeout(()=>d.remove(),2500);
        }
        window.toast = toast;

        function checkGPS() {
            if(!navigator.geolocation) { document.getElementById('gpsDot').classList.add('inactive'); document.getElementById('gpsText').textContent='N/A'; return; }
            navigator.geolocation.getCurrentPosition(
                ()=>{ document.getElementById('gpsDot').classList.add('active'); document.getElementById('gpsText').textContent='GPS ON'; },
                ()=>{ document.getElementById('gpsDot').classList.add('inactive'); document.getElementById('gpsText').textContent='GPS OFF'; },
                {timeout:5000}
            );
        }

        window.setSpeed = m => {
            speed=m;
            document.querySelectorAll('.speed-btn').forEach(b=>b.className=b.dataset.mode===m?'speed-btn '+m+' active':'speed-btn inactive');
            updMode();
        };

        window.updMode = () => {
            const m = document.getElementById('modelSel').value;
            const n = m.includes('pro')?'Pro':m.includes('8b')?'8B':'Flash';
            const c = {fast:'var(--success)',balanced:'var(--warning)',quality:'var(--danger)'};
            document.getElementById('modeBadge').innerHTML = `<div class="mode-dot" style="background:${c[fast]}"></div><span>${n}</span>`;
        };

        window.fetchProxies = async () => {
            toast('Mencari...','info');
            try{
                const r = await fetch('https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=10000');
                const t = await r.text();
                proxies = t.split('\n').filter(l=>l.includes(':')).map(l=>l.trim()).slice(0,40);
                document.getElementById('proxyCount').textContent = proxies.length;
                document.getElementById('proxyNum').textContent = proxies.length;
                toast(proxies.length+' proxies','success');
            }catch(e){ toast('Proxy error','error'); }
        };

        window.toggleTor = () => {
            tor=!tor;
            document.getElementById('torBtn').innerHTML = `<i class="fa-solid fa-user-secret"></i> Incognito: ${tor?'ON':'OFF'}`;
            document.getElementById('torBtn').classList.toggle('tor-active',tor);
            toast('Incognito '+(tor?'on':'off'),'info');
        };

        onAuthStateChanged(auth, u => {
            if(u){
                user=u;
                const n = u.displayName||u.email?.split('@')[0]||'Guest';
                document.getElementById('userName').textContent = n.toUpperCase();
                document.getElementById('avatarBtn').textContent = n[0].toUpperCase();
                document.getElementById('authScreen').style.display='none';
                document.getElementById('mainUI').style.display='flex';
                setTimeout(()=>{ document.getElementById('statusDot').className='status-dot online'; document.getElementById('statusText').textContent='ONLINE'; },600);
                checkGPS();
                loadHist();
                initGlobal();
            }
        });

        window.handleAuth = () => {
            const e=document.getElementById('emailInput').value.trim(), p=document.getElementById('passInput').value;
            if(!e||!p){ toast('Fill fields','error'); return; }
            if(isLogin) signInWithEmailAndPassword(auth,e,p).catch(er=>toast(er.message,'error'));
            else createUserWithEmailAndPassword(auth,e,p).catch(er=>toast(er.message,'error'));
        };
        window.handleGoogle = () => signInWithPopup(auth,prov);
        window.handleAnonLogin = () => {
            signInAnonymously(auth).catch(()=>{
                user = {uid:'g_'+Math.random().toString(36).substr(2,8),isAnonymous:true};
                document.getElementById('authScreen').style.display='none';
                document.getElementById('mainUI').style.display='flex';
                toast('Guest mode','info');
            });
        };
        window.toggleAuthMode = () => {
            isLogin=!isLogin;
            document.getElementById('authToggleBtn').textContent = isLogin?'belum punya akun? daftar':'sudah punya akun? Login';
            document.getElementById('authBtn').textContent = isLogin?'Initialize Connection':'buat akun';
        };
        window.logout = () => signOut(auth)
        function updateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset();
            let zone = '';
            if(offset === -420) zone = 'WIB';
            else if(offset === -480) zone = 'WITA';
            else if(offset === -540) zone = 'WIT';
            else zone = Intl.DateTimeFormat().resolvedOptions().timeZone.split('/').pop();
            
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('id-ID',{hour12:false});
        }
        setInterval(updateTime,1000);
        updateTime();

        function renderP(d) {
            document.getElementById('portalGrid').innerHTML = d.map(p=>`
                <div class="portal-card" onclick="enterP('${p.id}','${p.name}','${p.ic}','${p.c}')">
                    <div class="portal-icon" style="background:${p.c}18;color:${p.c};border:1px solid ${p.c}35"><i class="fa-solid ${p.ic}"></i></div>
                    <div class="portal-name">${p.name}</div>
                    <div class="portal-desc">${p.desc}</div>
                </div>
            `).join('');
        }
        renderP(portals);

        window.filterPortals = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderP(portals.filter(p=>p.name.toLowerCase().includes(q)||p.desc.toLowerCase().includes(q)));
        };

        window.enterP = (id,nm,ic,c) => {
            activePortal=nm;
            document.getElementById('lobbyView').classList.add('hidden');
            document.getElementById('workspaceView').classList.add('active');
            document.getElementById('backBtn').classList.add('show');
            document.getElementById('chatPortalName').textContent=nm;
            document.getElementById('chatPortalDesc').textContent=nm+' Active';
            document.getElementById('chatPortalIcon').innerHTML=`<i class="fa-solid ${ic}"></i>`;
            document.getElementById('chatPortalIcon').style.background=c+'18';
            document.getElementById('chatPortalIcon').style.color=c;
            document.getElementById('chatBox').innerHTML='<div class="message message-ai"><div class="message-sender">'+nm+'</div><div class="message-text">Portal activated. Ready to assist.</div></div>';
            setTimeout(()=>document.getElementById('chatInput').focus(),60);
        };

        window.exitPortal = () => {
            document.getElementById('lobbyView').classList.remove('hidden');
            document.getElementById('workspaceView').classList.remove('active');
            document.getElementById('backBtn').classList.remove('show');
        };

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

        window.openHist = () => document.getElementById('histPanel').classList.add('open');
        window.closeHist = () => document.getElementById('histPanel').classList.remove('open');
        window.openContact = () => document.getElementById('contactPanel').classList.add('open');
        window.closeContact = () => document.getElementById('contactPanel').classList.remove('open');
        window.openGlobal = () => document.getElementById('globalPanel').classList.add('open');
        window.closeGlobal = () => document.getElementById('globalPanel').classList.remove('open');

        async function loadHist() {
            if(!user) return;
            const l = document.getElementById('histList');
            try{
                const sn = await getDocs(query(collection(db,'artifacts','virza-v12','users',user.uid,'history'),orderBy('timestamp','desc'),limit(30)));
                if(sn.empty) return;
                l.innerHTML='';
                sn.forEach(d=>{
                    const dt=d.data(), tm=dt.timestamp?.toDate?.()||new Date();
                    const it=document.createElement('div');
                    it.className='history-item';
                    it.innerHTML=`<div class="history-meta"><span class="history-portal">${dt.portal||'General'}</span><span class="history-time">${tm.toLocaleString('id-ID',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</span></div><div class="history-prompt">"${dt.prompt}"</div>`;
                    it.onclick=()=>{ document.getElementById('chatInput').value=dt.prompt; closeHist(); };
                    l.appendChild(it);
                });
            }catch(e){}
        }

        window.clearChat = () => {
            document.getElementById('chatBox').innerHTML='<div class="message message-ai"><div class="message-sender">Nexus AI</div><div class="message-text">Chat cleared. Ready!</div></div>';
            toast('Cleared','success');
        };

        window.toggleAttach = () => document.getElementById('attachMenu').classList.toggle('show');
        window.addAttach = t => {
            document.getElementById('attachMenu').classList.remove('show');
            const fi=document.getElementById('fileInput');
            fi.accept = t==='image'?'image/*':'.txt';
            fi.click();
        };

        window.handleFile = e => {
            const f=e.target.files[0]; if(!f) return;
            attach = {type:f.type.startsWith('image')?'image':'txt',file:f,name:f.name,size:(f.size/1024).toFixed(1)+'KB'};
            toast('File: '+f.name,'success');
        };

        window.sendMsg = async () => {
            const inp=document.getElementById('chatInput'), pr=inp.value.trim();
            if(!pr&&!attach) return;
            const kd=getKey(); if(!kd) return;
            const{k,i}=kd;
            const cb=document.getElementById('chatBox'), sb=document.getElementById('sendBtn');

            let fp=pr;
            if(attach&&attach.type==='txt'&&attach.file){
                const txt = await attach.file.text();
                fp = `[File: ${attach.name}]\nContent:\n${txt.substring(0,3000)}\n\nUser: ${pr}`;
            }

            let parts = [];
            if(attach&&attach.type==='image'&&attach.file){
                const b64 = await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result.split(',')[1]);r.readAsDataURL(attach.file);});
                parts.push({inline_data:{mime_type:attach.file.type,data:b64}});
                parts.push({text:pr||"Analyze this image"});
            } else {
                parts.push({text:fp});
            }

            let uh='<div class="message message-user">';
            if(attach?.type==='image'&&attach.file){
                const id=await new Promise(r=>{const rd=new FileReader();rd.onload=e=>r(e.target.result);rd.readAsDataURL(attach.file);});
                uh+=`<img src="${id}" style="max-width:150px;border-radius:6px;margin-bottom:4px">`;
            }
            uh+=`<div class="message-text">${pr}</div></div>`;
            cb.innerHTML+=uh;

            inp.value=''; inp.style.height='auto';
            attach=null;
            cb.scrollTop=cb.scrollHeight;

            if(user){
                try{ await addDoc(collection(db,'artifacts','virza-v12','users',user.uid,'history'),{prompt:pr,portal:activePortal,timestamp:serverTimestamp()}); }catch(e){}
        }

        const tid='t'+Date.now();
            cb.innerHTML+=`<div id="${tid}" class="message message-ai"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            cb.scrollTop=cb.scrollHeight;

            try{
                sb.disabled=true;
                const md=document.getElementById('modelSel').value;
                const WORKER = "https://nexus.visiaura.workers.dev";
                const target = `https://generativelanguage.googleapis.com/v1beta/models/${md}:generateContent?key=${k}`;
                const url = `${WORKER}?url=${encodeURIComponent(target)}`;

                const re=await fetch(url,{
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{parts:parts}],generationConfig:SPEED_CFG[speed]})
                });
                document.getElementById(tid)?.remove();
                const dt=await re.json();
                if(dt.error){
                    if(dt.error.message?.includes('quota')||dt.error.status==='RESOURCE_EXHAUSTED'){ markKey(i); toast('Key limited','warning'); sb.disabled=false; setTimeout(()=>sendMsg(),200); return; }
                    throw new Error(dt.error.message||'API Error');
                }
                const tx=dt.candidates?.[0]?.content?.parts?.[0]?.text||'No response';
                cb.innerHTML+=`<div class="message message-ai"><div class="message-sender">Nexus AI</div><div class="message-text">${tx.replace(/\n/g,'<br>')}</div></div>`;
                msgs++; reqs++;
                document.getElementById('msgNum').textContent=msgs;
                document.getElementById('reqNum').textContent=reqs;
                sb.disabled=false;
            }catch(e){
                document.getElementById(tid)?.remove();
                cb.innerHTML+=`<div class="message message-ai"><div class="message-text" style="color:var(--danger)">Error: ${e.message}</div></div>`;
                sb.disabled=false;
            }
            cb.scrollTop=cb.scrollHeight;
        };

        function initGlobal() {
            if(!user) return;
            const q = query(collection(db,'chatrooms','global','messages'),orderBy('timestamp','asc'),limit(50));
            onSnapshot(q, snap => {
                const box = document.getElementById('globalBox');
                box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const div = document.createElement('div');
                    div.className = 'global-msg '+(m.uid===user.uid?'self':'other');
                    div.innerHTML = `<div style="font-size:0.55rem;opacity:0.7;margin-bottom:2px">${m.name||'Anon'}</div><div>${m.text}</div>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendGlobal = async () => {
            const inp = document.getElementById('globalInput');
            const txt = inp.value.trim();
            if(!txt||!user) return;
            await addDoc(collection(db,'chatrooms','global','messages'),{
                text: txt,
                uid: user.uid,
                name: user.displayName||user.email?.split('@')[0]||'Ghost',
                timestamp: serverTimestamp()
            });
            inp.value = '';
        };

        window.autoResize = el => { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,80)+'px'; };
        window.handleKey = e => { if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMsg(); } };

        document.addEventListener('click',e=>{
            if(!e.target.closest('.attachment-btn')&&!e.target.closest('.attachment-menu')) document.getElementById('attachMenu').classList.remove('show');
        });

        setTimeout(()=>fetchProxies(),3500);
        setInterval(()=>fetchProxies(),1800000);
    </script>
</body>
</html>
