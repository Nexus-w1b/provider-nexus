<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virza Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #00d4ff;
            --accent-2: #7b2cbf;
            --success: #00ff88;
            --warning: #ffbe0b;
            --danger: #ff006e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #030014;
            color: #e0e7ff;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            font-size: 14px;
        }

        @media (min-width: 768px) { body { font-size: 16px; } }

        /* Background */
        .space-bg {
            position: fixed; inset: 0; z-index: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(123, 44, 191, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
        }

        .stars-layer { position: absolute; inset: 0; overflow: hidden; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 4s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.6; } }

                /* ========== LOADING SCREEN FIX 2.0 ========== */
        .loading-screen {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
            transition: opacity 0.3s ease-out;
        }
        .loading-screen.hide { opacity: 0; pointer-events: none; }

        .spaceship-3d {
            position: relative; 
            width: 100px; height: 150px;
            /* Langsung muncul, animasi float pelan */
            animation: shipFloat 2s ease-in-out infinite;
            transition: transform 0.5s ease-in;
        }
        /* Kelas terbang keluar */
        .spaceship-3d.fly-out {
            transform: translateY(-150vh) scale(0.5); 
            opacity: 0;
        }

        @media (min-width: 768px) { .spaceship-3d { width: 140px; height: 200px; } }

        @keyframes shipFloat {
            0%, 100% { transform: translateY(0) rotateY(0); }
            50% { transform: translateY(-5px) rotateY(3deg); }
        }

        /* Pesawat Badan */
        .rocket-body { position: absolute; left: 50%; top: 35px; transform: translateX(-50%); width: 35px; height: 80px; background: linear-gradient(90deg, #1e293b, #94a3b8 50%, #1e293b); border-radius: 50% 50% 15% 15% / 60% 60% 10% 10%; box-shadow: 0 10px 25px rgba(0, 212, 255, 0.2); }
        @media (min-width: 768px) { .rocket-body { width: 50px; height: 110px; top: 45px; } }

        .rocket-nose { position: absolute; left: 50%; top: 0; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-bottom: 35px solid #dc2626; }
        @media (min-width: 768px) { .rocket-nose { border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 45px solid #dc2626; } }

        .rocket-window { position: absolute; left: 50%; top: 50px; transform: translateX(-50%); width: 12px; height: 12px; background: radial-gradient(circle, #00d4ff, #0369a1); border-radius: 50%; border: 2px solid #334155; box-shadow: 0 0 10px var(--accent); }
        @media (min-width: 768px) { .rocket-window { width: 18px; height: 18px; top: 65px; } }

        .fin-left, .fin-right { position: absolute; bottom: 20px; }
        .fin-left { left: 6px; border-right: 18px solid #b91c1c; border-top: 8px solid transparent; border-bottom: 25px solid transparent; transform: rotate(-10deg); }
        .fin-right { right: 6px; border-left: 18px solid #b91c1c; border-top: 8px solid transparent; border-bottom: 25px solid transparent; transform: rotate(10deg); }
        @media (min-width: 768px) { .fin-left { left: 10px; } .fin-right { right: 10px; } }

        .flame { position: absolute; left: 50%; bottom: -35px; transform: translateX(-50%); width: 20px; height: 40px; background: linear-gradient(to top, #ff3300, #ffcc00, #fff); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; animation: flicker 0.1s infinite alternate; box-shadow: 0 0 15px #ff6600; }
        @media (min-width: 768px) { .flame { width: 30px; height: 55px; bottom: -45px; } }
        @keyframes flicker { 0% { transform: translateX(-50%) scaleY(1); } 100% { transform: translateX(-50%) scaleY(1.1); } }

        .loading-text { margin-top: 50px; text-align: center; }
        .loading-title { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 900; letter-spacing: 0.2em; color: var(--accent); text-shadow: 0 0 15px var(--accent); }
        @media (min-width: 768px) { .loading-title { font-size: 2rem; } }

        /* Progress Bar Cepat 1.5s */
        .progress-bar { width: 120px; height: 2px; background: rgba(0, 212, 255, 0.15); border-radius: 2px; margin: 0.6rem auto; overflow: hidden; }
        @media (min-width: 768px) { .progress-bar { width: 180px; height: 3px; margin: 0.8rem auto; } }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
        /* Animasi di kontrol JS, bukan CSS */
        
        .loading-status { font-family: 'Orbitron', sans-serif; font-size: 0.45rem; color: var(--accent); letter-spacing: 0.15em; text-transform: uppercase; margin-top: 0.3rem; }
        @media (min-width: 768px) { .loading-status { font-size: 0.55rem; } }

      
        /* Auth & Main UI */
        .auth-screen { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .station-panel { width: 100%; max-width: 340px; padding: 1.5rem; background: rgba(3, 0, 20, 0.95); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 0.8rem; position: relative; overflow: hidden; }
        @media (min-width: 768px) { .station-panel { max-width: 380px; padding: 2rem; border-radius: 1rem; } }
        .station-panel::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); }

        .input-group { position: relative; margin-bottom: 0.5rem; }
        @media (min-width: 768px) { .input-group { margin-bottom: 0.7rem; } }
        .input-group i { position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%); color: var(--accent); opacity: 0.7; font-size: 0.75rem; }
        @media (min-width: 768px) { .input-group i { left: 0.8rem; font-size: 0.85rem; } }
        .input-group input { width: 100%; padding: 0.5rem 0.6rem 0.5rem 1.8rem; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.4rem; color: white; font-size: 0.75rem; outline: none; }
        @media (min-width: 768px) { .input-group input { padding: 0.6rem 0.8rem 0.6rem 2.3rem; font-size: 0.8rem; border-radius: 0.5rem; } }

        .btn-primary { width: 100%; padding: 0.5rem; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; border-radius: 0.4rem; color: white; font-family: 'Orbitron', sans-serif; font-size: 0.65rem; font-weight: 700; cursor: pointer; }
        @media (min-width: 768px) { .btn-primary { padding: 0.6rem; font-size: 0.7rem; border-radius: 0.5rem; } }
        
        .btn-secondary { width: 100%; padding: 0.4rem; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.4rem; color: var(--accent); font-size: 0.65rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.3rem; margin-top: 0.3rem; }
        @media (min-width: 768px) { .btn-secondary { padding: 0.5rem; font-size: 0.7rem; gap: 0.4rem; margin-top: 0.4rem; } }

        .main-ui { position: relative; z-index: 10; display: none; flex-direction: column; height: 100%; }

        .header { height: 44px; background: rgba(3, 0, 20, 0.9); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(0, 212, 255, 0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 0.5rem; }
        @media (min-width: 768px) { .header { height: 52px; padding: 0 0.75rem; } }

        .back-btn { width: 26px; height: 26px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.3rem; display: none; align-items: center; justify-content: center; color: var(--accent); cursor: pointer; font-size: 0.7rem; }
        @media (min-width: 768px) { .back-btn { width: 30px; height: 30px; font-size: 0.8rem; } }
        .back-btn.show { display: flex; }
        
        .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--warning); }
        @media (min-width: 768px) { .status-dot { width: 6px; height: 6px; } }
        .status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        
        .time-display { font-family: 'Orbitron', sans-serif; font-size: 0.6rem; font-weight: 700; }
        @media (min-width: 768px) { .time-display { font-size: 0.75rem; } }
        .date-display { font-size: 0.4rem; color: #64748b; display: none; }
        @media (min-width: 768px) { .date-display { display: block; font-size: 0.45rem; } }

        .gps-indicator { display: flex; align-items: center; gap: 2px; padding: 1px 4px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 0.35rem; }
        .gps-dot { width: 4px; height: 4px; border-radius: 50%; background: #4a5568; }
        .gps-dot.active { background: var(--success); box-shadow: 0 0 4px var(--success); }
        .gps-dot.inactive { background: var(--danger); }

        .avatar-btn { width: 26px; height: 26px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 0.55rem; font-weight: 700; cursor: pointer; }
        @media (min-width: 768px) { .avatar-btn { width: 30px; height: 30px; font-size: 0.65rem; } }
        
        /* HAMBURGER BUTTON FIX */
        .settings-btn { width: 26px; height: 26px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.3rem; display: flex; align-items: center; justify-content: center; color: var(--accent); cursor: pointer; font-size: 0.7rem; }
        @media (min-width: 768px) { .settings-btn { width: 30px; height: 30px; font-size: 0.8rem; } }

        .header-badge { padding: 0.1rem 0.3rem; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.5rem; font-size: 0.4rem; color: var(--accent); }
        @media (min-width: 768px) { .header-badge { font-size: 0.5rem; } }

        .main-content { flex: 1; overflow: hidden; position: relative; }
        .lobby-view { position: absolute; inset: 0; overflow-y: auto; padding: 0.5rem; }
        @media (min-width: 768px) { .lobby-view { padding: 0.75rem; } }

        .portal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
        @media (min-width: 480px) { .portal-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .portal-grid { grid-template-columns: repeat(4, 1fr); gap: 0.6rem; } }
        @media (min-width: 1024px) { .portal-grid { grid-template-columns: repeat(5, 1fr); } }

        .portal-card { padding: 0.5rem; background: rgba(10, 10, 31, 0.7); border: 1px solid rgba(0, 212, 255, 0.1); border-radius: 0.5rem; cursor: pointer; transition: transform 0.2s; }
        @media (min-width: 768px) { .portal-card { padding: 0.7rem; border-radius: 0.7rem; } }
        .portal-card:active { transform: scale(0.97); }
        .portal-icon { width: 24px; height: 24px; border-radius: 0.3rem; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; margin-bottom: 0.2rem; }
        @media (min-width: 768px) { .portal-icon { width: 32px; height: 32px; border-radius: 0.4rem; font-size: 0.85rem; margin-bottom: 0.3rem; } }
        .portal-name { font-family: 'Orbitron', sans-serif; font-size: 0.45rem; font-weight: 700; text-transform: uppercase; }
        @media (min-width: 768px) { .portal-name { font-size: 0.55rem; } }
        .portal-desc { display: none; }
        @media (min-width: 768px) { .portal-desc { display: block; font-size: 0.4rem; color: #64748b; margin-top: 0.1rem; } }

        .workspace-view { position: absolute; inset: 0; display: none; flex-direction: column; }
        .workspace-view.active { display: flex; }
        
        .chat-panel { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 0.3rem 0.5rem; background: rgba(0, 0, 0, 0.25); border-bottom: 1px solid rgba(0, 212, 255, 0.08); display: flex; align-items: center; justify-content: space-between; }
        @media (min-width: 768px) { .chat-header { padding: 0.4rem 0.7rem; } }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.3rem; }
        @media (min-width: 768px) { .chat-box { padding: 0.7rem; gap: 0.5rem; } }
        
        .message { max-width: 85%; padding: 0.4rem 0.5rem; border-radius: 0.5rem; animation: msgSlide 0.2s ease-out; font-size: 0.6rem; line-height: 1.3; }
        @media (min-width: 768px) { .message { padding: 0.5rem 0.65rem; border-radius: 0.7rem; font-size: 0.7rem; } }
        @keyframes msgSlide { from { opacity: 0; transform: translateY(4px); } }
        .message-user { align-self: flex-end; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 0.5rem 0.5rem 0.1rem 0.5rem; }
        .message-ai { align-self: flex-start; background: rgba(0, 0, 0, 0.35); border: 1px solid rgba(0, 212, 255, 0.1); border-radius: 0.5rem 0.5rem 0.5rem 0.1rem; }
        
        .typing-indicator { display: flex; gap: 0.1rem; padding: 0.2rem 0; }
        .typing-indicator span { width: 3px; height: 3px; background: var(--accent); border-radius: 50%; animation: typing 1.2s infinite; }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .chat-input-area { padding: 0.3rem; background: rgba(3, 0, 20, 0.95); border-top: 1px solid rgba(0, 212, 255, 0.08); }
        @media (min-width: 768px) { .chat-input-area { padding: 0.5rem; } }
        
        .chat-input-row { display: flex; gap: 0.2rem; }
        @media (min-width: 768px) { .chat-input-row { gap: 0.3rem; } }
        
        .attachment-btn { width: 28px; height: 28px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.3rem; color: var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; font-size: 0.7rem; }
        @media (min-width: 768px) { .attachment-btn { width: 32px; height: 32px; font-size: 0.8rem; } }
        
        .attachment-menu { position: absolute; bottom: 100%; left: 0; margin-bottom: 0.2rem; background: rgba(10, 10, 31, 0.98); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.3rem; display: none; flex-direction: column; min-width: 90px; z-index: 100; font-size: 0.6rem; }
        @media (min-width: 768px) { .attachment-menu { min-width: 110px; font-size: 0.65rem; } }
        .attachment-menu.show { display: flex; }
        .attachment-menu button { display: flex; align-items: center; gap: 0.2rem; padding: 0.25rem 0.3rem; background: transparent; border: none; color: #e0e7ff; cursor: pointer; text-align: left; }
        
        .chat-textarea { flex: 1; padding: 0.35rem; background: rgba(0, 0, 0, 0.35); border: 1px solid rgba(0, 212, 255, 0.12); border-radius: 0.3rem; color: white; font-size: 0.6rem; outline: none; resize: none; max-height: 50px; }
        @media (min-width: 768px) { .chat-textarea { padding: 0.4rem; font-size: 0.7rem; border-radius: 0.4rem; max-height: 60px; } }
        
        .send-btn { width: 28px; height: 28px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; border-radius: 0.3rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        @media (min-width: 768px) { .send-btn { width: 32px; height: 32px; font-size: 0.8rem; } }

        .speed-row { display: flex; align-items: center; justify-content: center; gap: 0.2rem; margin-top: 0.2rem; }
        @media (min-width: 768px) { .speed-row { gap: 0.3rem; margin-top: 0.3rem; } }
        .speed-btn { padding: 0.1rem 0.25rem; border-radius: 0.5rem; font-size: 0.35rem; font-weight: 700; text-transform: uppercase; border: 1px solid; cursor: pointer; background: transparent; }
        @media (min-width: 768px) { .speed-btn { padding: 0.15rem 0.4rem; font-size: 0.45rem; } }
        .speed-btn.fast { color: var(--success); border-color: rgba(0, 255, 136, 0.25); }
        .speed-btn.balanced { color: var(--warning); border-color: rgba(255, 190, 11, 0.25); }
        .speed-btn.quality { color: var(--danger); border-color: rgba(255, 0, 110, 0.25); }
        .speed-btn.active { box-shadow: 0 0 8px currentColor; }

        /* SIDEBAR FIX */
        .sidebar { position: fixed; inset-y: 0; right: 0; width: 260px; max-width: 80vw; background: rgba(3, 0, 20, 0.98); border-left: 1px solid rgba(0, 212, 255, 0.15); transform: translateX(100%); transition: transform 0.3s ease-out; z-index: 1000; display: flex; flex-direction: column; touch-action: pan-y; }
        @media (min-width: 768px) { .sidebar { width: 300px; max-width: 300px; } }
        .sidebar.open { transform: translateX(0); }
        
        .sidebar-header { padding: 0.5rem; border-bottom: 1px solid rgba(0, 212, 255, 0.08); display: flex; align-items: center; justify-content: space-between; }
        @media (min-width: 768px) { .sidebar-header { padding: 0.75rem; } }
        .sidebar-title { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        @media (min-width: 768px) { .sidebar-title { font-size: 0.8rem; } }
        .sidebar-title span { color: var(--accent); }
        .sidebar-close { width: 22px; height: 22px; background: rgba(0, 212, 255, 0.1); border: none; border-radius: 50%; color: var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;
        .sidebar-body { flex: 1; overflow-y: auto; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.4rem; }
        @media (min-width: 768px) { .sidebar-body { padding: 0.65rem; gap: 0.6rem; } }
        
        .sidebar-section { padding: 0.5rem; background: rgba(0, 0, 0, 0.25); border: 1px solid rgba(0, 212, 255, 0.08); border-radius: 0.3rem; }
        @media (min-width: 768px) { .sidebar-section { padding: 0.65rem; border-radius: 0.45rem; } }
        .sidebar-section-title { font-family: 'Orbitron', sans-serif; font-size: 0.45rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.2rem; }
        @media (min-width: 768px) { .sidebar-section-title { font-size: 0.55rem; margin-bottom: 0.45rem; gap: 0.3rem; } }
        .sidebar-section-title i { color: var(--accent); font-size: 0.5rem; }
        @media (min-width: 768px) { .sidebar-section-title i { font-size: 0.6rem; } }
        
        .key-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.1rem; margin-top: 0.2rem; }
        .key-dot { aspect-ratio: 1; border-radius: 2px; transition: all 0.3s; }
        .key-dot.active { background: var(--success); box-shadow: 0 0 3px var(--success); }
        .key-dot.exhausted { background: var(--danger); opacity: 0.5; }
        .key-dot.standby { background: rgba(0, 212, 255, 0.3); }
        
        .proxy-actions { display: flex; flex-direction: column; gap: 0.15rem; }
        @media (min-width: 768px) { .proxy-actions { gap: 0.2rem; } }
        .proxy-btn { padding: 0.3rem; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 0.2rem; color: var(--accent); font-size: 0.4rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.2rem; font-family: 'Rajdhani', sans-serif; }
        @media (min-width: 768px) { .proxy-btn { padding: 0.4rem; font-size: 0.5rem; border-radius: 0.3rem; gap: 0.3rem; } }
        .proxy-btn.tor-active { background: rgba(123, 44, 191, 0.15); color: var(--accent-2); }
        
        .quick-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.2rem; }
        .stat-card { padding: 0.3rem; background: rgba(0, 0, 0, 0.25); border: 1px solid rgba(0, 212, 255, 0.06); border-radius: 0.2rem; text-align: center; }
        @media (min-width: 768px) { .stat-card { padding: 0.45rem; } }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: 800; color: var(--accent); }
        @media (min-width: 768px) { .stat-value { font-size: 0.9rem; } }
        .stat-label { font-size: 0.35rem; color: #64748b; text-transform: uppercase; }
        
        .sidebar-actions { display: flex; flex-direction: column; gap: 0.15rem; }
        @media (min-width: 768px) { .sidebar-actions { gap: 0.2rem; } }
        .action-btn { padding: 0.35rem; background: rgba(0, 212, 255, 0.08); border: 1px solid rgba(0, 212, 255, 0.15); border-radius: 0.2rem; color: var(--accent); font-size: 0.45rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.2rem; }
        @media (min-width: 768px) { .action-btn { padding: 0.45rem; font-size: 0.55rem; border-radius: 0.3rem; gap: 0.3rem; } }
        .action-btn.danger { background: rgba(255, 0, 110, 0.08); border-color: rgba(255, 0, 110, 0.15); color: var(--danger); }
        
        .sidebar-footer { padding: 0.5rem; border-top: 1px solid rgba(0, 212, 255, 0.08); }
        @media (min-width: 768px) { .sidebar-footer { padding: 0.65rem; } }
        .logout-btn { width: 100%; padding: 0.4rem; background: rgba(255, 0, 110, 0.1); border: 1px solid rgba(255, 0, 110, 0.2); border-radius: 0.3rem; color: var(--danger); font-family: 'Orbitron', sans-serif; font-size: 0.45rem; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        @media (min-width: 768px) { .logout-btn { padding: 0.5rem; font-size: 0.55rem; } }

        /* Panels */
        .panel-overlay { position: fixed; inset: 0; z-index: 900; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; padding: 0.5rem; }
        .panel-overlay.open { display: flex; }
        .panel-content { width: 100%; max-width: 340px; background: rgba(3, 0, 20, 0.98); border: 1px solid rgba(0, 212, 255, 0.15); border-radius: 0.5rem; padding: 0.8rem; }
        @media (min-width: 768px) { .panel-content { max-width: 380px; padding: 1.1rem; border-radius: 0.7rem; } }
        .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.6rem; }
        @media (min-width: 768px) { .panel-header { margin-bottom: 0.9rem; } }
        .panel-title { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.7rem; }
        @media (min-width: 768px) { .panel-title { font-size: 0.8rem; } }

        .global-panel .panel-content { max-width: 360px; height: 55vh; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .global-panel .panel-content { max-width: 420px; height: 60vh; } }
        .global-chat-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.6rem; }
        .global-msg { padding: 0.35rem 0.4rem; border-radius: 0.35rem; max-width: 80%; }
        .global-msg.self { align-self: flex-end; background: rgba(0, 212, 255, 0.15); }
        .global-msg.other { align-self: flex-start; background: rgba(255, 255, 255, 0.05); }
        .global-input-area { display: flex; gap: 0.2rem; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid rgba(0, 212, 255, 0.08); }
        .global-input { flex: 1; padding: 0.35rem; background: rgba(0, 0, 0, 0.35); border: 1px solid rgba(0, 212, 255, 0.12); border-radius: 0.3rem; color: white; font-size: 0.6rem; outline: none; }

        .contact-btn { padding: 0.55rem; background: rgba(0, 212, 255, 0.08); border: 1px solid rgba(0, 212, 255, 0.15); border-radius: 0.4rem; color: white; font-size: 0.6rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; text-decoration: none; margin-bottom: 0.4rem; }
        @media (min-width: 768px) { .contact-btn { padding: 0.75rem; font-size: 0.7rem; border-radius: 0.5rem; gap: 0.6rem; margin-bottom: 0.5rem; } }
        .contact-btn i { font-size: 0.8rem; }
        @media (min-width: 768px) { .contact-btn i { font-size: 1rem; } }
        .contact-btn.email i { color: var(--accent); }
        .contact-btn.whatsapp i { color: #25D366; }

        .history-item { padding: 0.35rem; background: rgba(0, 0, 0, 0.25); border: 1px solid rgba(0, 212, 255, 0.08); border-radius: 0.25rem; margin-bottom: 0.2rem; cursor: pointer; }
        @media (min-width: 768px) { .history-item { padding: 0.5rem; border-radius: 0.35rem; margin-bottom: 0.3rem; } }

        /* Toast */
        .toast { position: fixed; bottom: 45px; left: 50%; transform: translateX(-50%); padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.5rem; font-weight: 600; z-index: 5000; animation: toastIn 0.2s ease-out; }
        @media (min-width: 768px) { .toast { bottom: 55px; padding: 0.5rem 1rem; font-size: 0.6rem; } }
        .toast.success { background: rgba(0, 255, 136, 0.95); color: #000; }
        .toast.error { background: rgba(255, 0, 110, 0.95); color: #fff; }
        .toast.warning { background: rgba(255, 190, 11, 0.95); color: #000; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } }

        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="space-bg">
        <div class="stars-layer" id="starsLayer"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="stars-layer" id="loadingStars"></div>
        <div class="spaceship-3d">
            <div class="rocket-nose"></div>
            <div class="rocket-body"><div class="rocket-window"></div></div>
            <div class="fin-left"></div>
            <div class="fin-right"></div>
            <div class="flame"></div>
        </div>
        <div class="loading-text">
            <div class="loading-title">NEXUS</div>
            <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            <div class="loading-status" id="loadingStatus"></div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="station-panel">
            <div style="text-align:center;margin-bottom:0.6rem;">
                <i class="fa-solid fa-rocket" style="font-size:1.2rem;color:var(--accent);"></i>
                <h1 style="font-family:'Orbitron';font-size:1.1rem;font-weight:900;margin-top:0.2rem;">NEXUS <span style="color:var(--accent)">STATION</span></h1>
                <p style="font-size:0.4rem;color:#64748b;letter-spacing:0.2em;margin-top:0.1rem;">VIRZA PORTAL</p>
            </div>
            <div class="input-group"><i class="fa-solid fa-envelope"></i><input type="email" id="emailInput" placeholder="Email"></div>
            <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="passInput" placeholder="Code"></div>
            <button class="btn-primary" id="authBtn">Login</button>
            <button class="btn-secondary btn-anonymous" id="anonBtn"><i class="fa-solid fa-user-secret"></i> Guest</button>
            <button class="btn-secondary" id="googleBtn"><i class="fa-brands fa-google"></i> Google</button>
            <div class="auth-toggle"><button id="authToggleBtn">Register</button></div>
        </div>
    </div>

    <!-- Main UI -->
    <div id="mainUI" class="main-ui">
        <header class="header">
            <div style="display:flex;align-items:center;gap:0.3rem;">
                <button class="back-btn" id="backBtn"><i class="fa-solid fa-arrow-left"></i></button>
                <div>
                    <div style="display:flex;align-items:center;gap:0.15rem;">
                        <div class="status-dot" id="statusDot"></div>
                        <span style="font-size:0.35rem;color:#64748b;" id="statusText">CONNECTING</span>
                    </div>
                    <div class="time-display" id="timeDisplay">--:--</div>
                    <div class="date-display" id="dateDisplay">--</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:0.25rem;">
                <div class="gps-indicator"><div class="gps-dot" id="gpsDot"></div><span id="gpsText">GPS</span></div>
                <div class="header-badge" id="keyBadge">2 Keys</div>
                <button class="avatar-btn" id="avatarBtn">V</button>
                <!-- INI TOMBOL HAMBURGER 3 GARIS -->
                <button class="settings-btn" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
        </header>

        <main class="main-content">
            <div id="lobbyView" class="lobby-view no-scrollbar">
                <div style="max-width:800px;margin:0 auto;">
                    <div style="text-align:center;margin-bottom:0.5rem;"><h2 style="font-family:'Orbitron';font-size:0.9rem;">Welcome, <span style="color:var(--accent)" id="userName">User</span></h2></div>
                    <div style="position:relative;margin-bottom:0.5rem;">
                        <i class="fa-solid fa-search" style="position:absolute;left:0.5rem;top:50%;transform:translateY(-50%);color:var(--accent);opacity:0.6;font-size:0.65rem;"></i>
                        <input type="text" class="chat-textarea" id="searchInput" placeholder="Search..." style="padding-left:1.6rem;padding:0.3rem 0.3rem 0.3rem 1.6rem;">
                    </div>
                    <div class="portal-grid" id="portalGrid"></div>
                </div>
            </div>

            <div id="workspaceView" class="workspace-view">
                <div class="chat-panel">
                    <div class="chat-header">
                        <div style="display:flex;align-items:center;gap:0.3rem;">
                            <div id="chatPortalIcon" style="width:22px;height:22px;border-radius:0.25rem;display:flex;align-items:center;justify-content:center;font-size:0.65rem;"><i class="fa-solid fa-robot"></i></div>
                            <div><div style="font-family:'Orbitron';font-size:0.55rem;font-weight:700;" id="chatPortalName">AI</div><div style="font-size:0.35rem;color:#64748b;" id="chatPortalDesc">Active</div></div>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.15rem;padding:0.15rem 0.3rem;background:rgba(0,0,0,0.35);border-radius:0.4rem;font-size:0.35rem;" id="modeBadge"><div style="width:3px;height:3px;background:var(--success);border-radius:50%;"></div><span>Fast</span></div>
                    </div>
                    <div class="chat-box no-scrollbar" id="chatBox"><div class="message message-ai"><div class="message-text">Ready.</div></div></div>
                    <div class="chat-input-area">
                        <div class="chat-input-row">
                            <div class="attachment-btn" id="attachBtn"><i class="fa-solid fa-plus"></i><div class="attachment-menu" id="attachMenu"><button data-type="image"><i class="fa-solid fa-image" style="color:var(--success)"></i> Photo</button><button data-type="txt"><i class="fa-solid fa-file-lines" style="color:var(--accent)"></i> TXT</button></div></div>
                            <textarea class="chat-textarea" id="chatInput" placeholder="Type..." rows="1"></textarea>
                            <button class="send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        <div class="speed-row">
                            <span style="font-size:0.35rem;color:#64748b;">Speed:</span>
                            <button class="speed-btn fast active" data-speed="fast">Fast</button>
                            <button class="speed-btn balanced" data-speed="balanced">Bal</button>
                            <button class="speed-btn quality" data-speed="quality">Quality</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

      <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><h3 class="sidebar-title">Vault <span>Control</span></h3><button class="sidebar-close" id="sidebarClose"><i class="fa-solid fa-xmark"></i></button></div>
        <div class="sidebar-body no-scrollbar">
            <div class="sidebar-section"><div class="sidebar-section-title"><i class="fa-solid fa-microchip"></i> AI</div><select id="modelSel" class="chat-textarea" style="padding:0.25rem;font-size:0.45rem;"><option value="gemini-1.5-flash">Flash</option><option value="gemini-1.5-flash-8b">8B</option><option value="gemini-1.5-pro">Pro</option></select></div>
            <div class="sidebar-section"><div class="sidebar-section-title"><i class="fa-solid fa-key"></i> Keys</div><div style="font-size:0.4rem;">Active: <strong id="activeKeyNum">2</strong>/2</div><div class="key-grid" id="keyGrid"></div></div>
            <div class="sidebar-section"><div class="sidebar-section-title"><i class="fa-solid fa-network-wired"></i> Proxy</div><div class="proxy-actions"><button class="proxy-btn" id="refreshProxyBtn"><i class="fa-solid fa-rotate"></i> Refresh (<span id="proxyNum">0</span>)</button><button class="proxy-btn" id="torBtn"><i class="fa-solid fa-user-secret"></i> Incognito: OFF</button><button class="proxy-btn" id="anonSidebarBtn"><i class="fa-solid fa-incognito"></i> Guest</button></div></div>
            <div class="sidebar-section"><div class="sidebar-section-title"><i class="fa-solid fa-chart-line"></i> Stats</div><div class="quick-stats"><div class="stat-card"><div class="stat-value" id="msgNum">0</div><div class="stat-label">Msg</div></div><div class="stat-card"><div class="stat-value" id="reqNum">0</div><div class="stat-label">Req</div></div></div></div>
            <div class="sidebar-actions"><button class="action-btn" id="globalBtn"><i class="fa-solid fa-users"></i> Lounge</button><button class="action-btn" id="historyBtn"><i class="fa-solid fa-clock-rotate-left"></i> History</button><button class="action-btn" id="clearBtn"><i class="fa-solid fa-broom"></i> Clear</button><button class="action-btn" id="contactBtn"><i class="fa-solid fa-envelope"></i> Contact</button></div>
        </div>
        <div class="sidebar-footer"><button class="logout-btn" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button></div>
    </aside>

    <!-- Panels -->
    <div class="panel-overlay" id="histPanel"><div class="panel-content"><div class="panel-header"><h3 class="panel-title">History</h3><button class="sidebar-close" id="closeHist"><i class="fa-solid fa-xmark"></i></button></div><div id="histList" style="max-height:35vh;overflow-y:auto;"></div></div></div>
    <div class="panel-overlay" id="contactPanel"><div class="panel-content"><div class="panel-header"><h3 class="panel-title">Contact</h3><button class="sidebar-close" id="closeContact"><i class="fa-solid fa-xmark"></i></button></div><a href="mailto:visi4ura@gmail.com" class="contact-btn email"><i class="fa-solid fa-envelope"></i><div><div style="font-weight:700;font-size:0.5rem;">Email</div><div style="font-size:0.45rem;color:#64748b;">visi4ura@gmail.com</div></div></a><a href="https://wa.me/6285715818953" target="_blank" class="contact-btn whatsapp"><i class="fa-brands fa-whatsapp"></i><div><div style="font-weight:700;font-size:0.5rem;">WhatsApp</div><div style="font-size:0.45rem;color:#64748b;">+62 857-1581-8953</div></div></a></div></div>
    <div class="panel-overlay global-panel" id="globalPanel"><div class="panel-content"><div class="panel-header"><h3 class="panel-title" style="color:var(--accent)"><i class="fa-solid fa-users"></i> Lounge</h3><button class="sidebar-close" id="closeGlobal"><i class="fa-solid fa-xmark"></i></button></div><div class="global-chat-box no-scrollbar" id="globalBox"></div><div class="global-input-area"><input type="text" class="global-input" id="globalInput" placeholder="Chat..."><button class="send-btn" id="sendGlobal"><i class="fa-solid fa-paper-plane"></i></button></div></div></div>

    <input type="file" id="fileInput" class="hidden" accept="image/*,.txt">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const fbConfig = { apiKey: "AIzaSyBK-MehTTzURY5jT5stH363Y5_WE4iy-XA", authDomain: "volca-tools.firebaseapp.com", projectId: "volca-tools", storageBucket: "volca-tools.firebasestorage.app", messagingSenderId: "262525907487", appId: "1:262525907487:web:4abc37fa3b583223569b2a" };

        const app = initializeApp(fbConfig); const auth = getAuth(app); const db = getFirestore(app);
        let user = null, attach = null, speed = 'fast', keyIdx = 0, exhausted = new Set(), proxies = [], tor = false, msgs = 0, reqs = 0, activePortal = 'General', isLogin = true;
        
        // API & PROXY CONFIG
        const KEYS = ["AIzaSyD0kRKiHoIs41PoMrCDkh0eygnlGvlh5ec", "AIzaSyDeLtumwyyQPGKQmiGtXBUnEV-J30AMmm4"];
        const WORKERS = ["https://nexus.visiaura.workers.dev", "https://geminiapi.visiaura.workers.dev"]; // Dual Worker
        const SPEED_CFG = { fast: { temperature: 0.5, maxOutputTokens: 1024 }, balanced: { temperature: 0.7, maxOutputTokens: 2048 }, quality: { temperature: 0.9, maxOutputTokens: 4096 } };
        
        const portals = [{id:'smart',name:'Smart',ic:'fa-brain',c:'#34d399',desc:'Chat'},{id:'code',name:'Code',ic:'fa-code',c:'#818cf8',desc:'Code'},{id:'img',name:'Image',ic:'fa-image',c:'#f472b6',desc:'Art'},{id:'vision',name:'Vision',ic:'fa-eye',c:'#fbbf24',desc:'Scan'},{id:'web',name:'Web',ic:'fa-globe',c:'#60a5fa',desc:'Site'},{id:'cyber',name:'Cyber',ic:'fa-shield',c:'#f87171',desc:'Sec'},{id:'math',name:'Math',ic:'fa-calculator',c:'#a78bfa',desc:'Math'},{id:'seo',name:'SEO',ic:'fa-magnifying-glass',c:'#2dd4bf',desc:'Opt'},{id:'data',name:'Data',ic:'fa-database',c:'#94a3b8',desc:'Data'},{id:'social',name:'Social',ic:'fa-hashtag',c:'#fb7185',desc:'Ads'},{id:'vid',name:'Video',ic:'fa-film',c:'#fb923c',desc:'Edit'},{id:'audio',name:'Audio',ic:'fa-music',c:'#4ade80',desc:'Sound'},{id:'logo',name:'Brand',ic:'fa-pen-nib',c:'#e879f9',desc:'Design'},{id:'lang',name:'Trans',ic:'fa-language',c:'#818cf8',desc:'Lang'},{id:'bug',name:'Debug',ic:'fa-bug',c:'#ef4444',desc:'Fix'},{id:'cloud',name:'Cloud',ic:'fa-cloud',c:'#38bdf8',desc:'Store'},{id:'sec',name:'Vault',ic:'fa-lock',c:'#fbbf24',desc:'Secure'},{id:'write',name:'Writer',ic:'fa-book',c:'#c084fc',desc:'Text'},{id:'game',name:'Game',ic:'fa-gamepad',c:'#f472b6',desc:'Dev'},{id:'law',name:'Law',ic:'fa-gavel',c:'#fca5a5',desc:'Legal'},{id:'health',name:'Health',ic:'fa-heart-pulse',c:'#ef4444',desc:'Med'},{id:'finance',name:'Finance',ic:'fa-chart-pie',c:'#22c55e',desc:'Fin'},{id:'edu',name:'Edu',ic:'fa-graduation-cap',c:'#3b82f6',desc:'Learn'},{id:'travel',name:'Travel',ic:'fa-plane',c:'#06b6d4',desc:'Trip'},{id:'recipe',name:'Chef',ic:'fa-utensils',c:'#f97316',desc:'Food'}];

        function toast(m, t = 'success') { const e = document.querySelector('.toast'); if (e) e.remove(); const d = document.createElement('div'); d.className = 'toast ' + t; d.textContent = m; document.body.appendChild(d); setTimeout(() => d.remove(), 2000); }
        function makeStars(el, n) { for (let i = 0; i < n; i++) { const s = document.createElement('div'); s.className = 'star'; s.style.cssText = `left:${Math.random() * 100}%;top:${Math.random() * 100}%;width:${Math.random() * 1 + 0.5}px;height:${Math.random() * 1 + 0.5}px;animation-delay:${Math.random() * 3}s`; el.appendChild(s); } }
        
        // LOADING: 3 Detik + Spaceship Fly Out
        function runLoad() {
            const statusText = document.getElementById('loadingStatus');
            const rocket = document.querySelector('.spaceship-3d');
            const loadingScreen = document.getElementById('loadingScreen');
            const authScreen = document.getElementById('authScreen');
            
            const steps = [
                { time: 200, text: "Initializing..." },
                { time: 1100, text: "Connecting..." },
                { time: 2100, text: "Systems Ready" },
                { time: 2800, text: "LAUNCH!", isEnd: true }
            ];

            steps.forEach(step => {
                setTimeout(() => {
                    statusText.style.opacity = 0;
                    setTimeout(() => {
                        statusText.textContent = step.text;
                        statusText.style.opacity = 1;
                        if (step.isEnd) {
                            rocket.classList.add('fly-out'); // Terbang!
                            setTimeout(() => {
                                loadingScreen.classList.add('hide');
                                authScreen.style.display = 'flex';
                            }, 800);
                        }
                    }, 150);
                }, step.time);
            });
        }
        
        makeStars(document.getElementById('starsLayer'), 40); makeStars(document.getElementById('loadingStars'), 20); runLoad();

        function updKeys() { document.getElementById('activeKeyNum').textContent = KEYS.length - exhausted.size; document.getElementById('keyBadge').textContent = (KEYS.length - exhausted.size) + ' Keys'; document.getElementById('keyGrid').innerHTML = KEYS.map((_, i) => `<div class="key-dot ${i === keyIdx && !exhausted.has(i) ? 'active' : exhausted.has(i) ? 'exhausted' : 'standby'}"></div>`).join(''); }
        updKeys();
        function getKey() { let a = 0; while (a < KEYS.length) { if (!exhausted.has(keyIdx)) { updKeys(); return { k: KEYS[keyIdx], i: keyIdx }; } keyIdx = (keyIdx + 1) % KEYS.length; a++; } toast('Keys limit', 'error'); return null; }
        function markKey(i) { exhausted.add(i); keyIdx = (i + 1) % KEYS.length; updKeys(); toast('Key ' + (i + 1) + ' limit', 'warning'); }
        function checkGPS() { if (!navigator.geolocation) { document.getElementById('gpsDot').classList.add('inactive'); document.getElementById('gpsText').textContent = 'X'; return; } navigator.geolocation.getCurrentPosition(() => { document.getElementById('gpsDot').classList.add('active'); document.getElementById('gpsText').textContent = 'ON'; }, () => { document.getElementById('gpsDot').classList.add('inactive'); document.getElementById('gpsText').textContent = 'OFF'; }, { timeout: 3000 }); }
        function updTime() { const n = new Date(); const o = n.getTimezoneOffset(); let z = ''; if (o === -420) z = 'WIB'; else if (o === -480) z = 'WITA'; else if (o === -540) z = 'WIT'; else z = 'GMT'; document.getElementById('timeDisplay').textContent = n.toLocaleTimeString('id-ID', { hour12: false }); document.getElementById('dateDisplay').textContent = n.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }) + ' ' + z; }
        setInterval(updTime, 1000); updTime();

        onAuthStateChanged(auth, u => { if (u) { user = u; const n = u.displayName || u.email?.split('@')[0] || 'Guest'; document.getElementById('userName').textContent = n.toUpperCase(); document.getElementById('avatarBtn').textContent = n[0].toUpperCase(); document.getElementById('authScreen').style.display = 'none'; document.getElementById('mainUI').style.display = 'flex'; document.getElementById('statusDot').classList.add('online'); document.getElementById('statusText').textContent = 'ONLINE'; checkGPS(); loadHist(); initGlobal(); } });
        document.getElementById('authBtn').onclick = () => { const e = document.getElementById('emailInput').value.trim(), p = document.getElementById('passInput').value; if (!e || !p) { toast('Fill', 'error'); return; } (isLogin ? signInWithEmailAndPassword : createUserWithEmailAndPassword)(auth, e, p).catch(er => toast(er.message, 'error')); };
        document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => toast(e.message, 'error'));
        document.getElementById('anonBtn').onclick = () => handleAnon(); document.getElementById('anonSidebarBtn').onclick = () => handleAnon();
        function handleAnon() { signInAnonymously(auth).catch(() => { user = { uid: 'g_' + Math.random().toString(36).substr(2, 8), isAnonymous: true }; document.getElementById('authScreen').style.display = 'none'; document.getElementById('mainUI').style.display = 'flex'; toast('Guest', 'info'); }); }
        document.getElementById('authToggleBtn').onclick = () => { isLogin = !isLogin; document.getElementById('authToggleBtn').textContent = isLogin ? 'Register' : 'Login'; document.getElementById('authBtn').textContent = isLogin ? 'Login' : 'Register'; };
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        // === SIDEBAR FIX: ID "sidebarToggle" DIPAKAI, BUKAN "settingsBtn" ===
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const avatarBtn = document.getElementById('avatarBtn');
        
        function toggleSidebar() { sidebar.classList.toggle('open'); }
        // Pasang di ID yang bener
        if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
        if (avatarBtn) avatarBtn.addEventListener('click', toggleSidebar);
        if (sidebarClose) sidebarClose.addEventListener('click', toggleSidebar);

        // Swipe
        let touchStartX = 0;
        document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
        document.addEventListener('touchmove', e => {
            const diff = e.touches[0].clientX - touchStartX;
            if (touchStartX > window.innerWidth - 30 && diff < -40) sidebar.classList.add('open');
        }, { passive: true });
        sidebar.addEventListener('touchmove', e => {
            if (e.touches[0].clientX - touchStartX > 50) sidebar.classList.remove('open');
        }, { passive: true });

        function renderP(d) { document.getElementById('portalGrid').innerHTML = d.map(p => `<div class="portal-card" data-id="${p.id}" data-name="${p.name}" data-ic="${p.ic}" data-c="${p.c}"><div class="portal-icon" style="background:${p.c}18;color:${p.c};border:1px solid ${p.c}30"><i class="fa-solid ${p.ic}"></i></div><div class="portal-name">${p.name}</div><div class="portal-desc">${p.desc}</div></div>`).join(''); }
        renderP(portals);
        document.getElementById('searchInput').oninput = function() { renderP(portals.filter(p => p.name.toLowerCase().includes(this.value.toLowerCase()))); };
        document.getElementById('portalGrid').onclick = function(e) { const c = e.target.closest('.portal-card'); if (!c) return; activePortal = c.dataset.name; document.getElementById('lobbyView').classList.add('hidden'); document.getElementById('workspaceView').classList.add('active'); document.getElementById('backBtn').classList.add('show'); document.getElementById('chatPortalName').textContent = c.dataset.name; document.getElementById('chatPortalIcon').innerHTML = `<i class="fa-solid ${c.dataset.ic}"></i>`; document.getElementById('chatPortalIcon').style.background = c.dataset.c + '18'; document.getElementById('chatPortalIcon').style.color = c.dataset.c; document.getElementById('chatBox').innerHTML = `<div class="message message-ai"><div class="message-text">${c.dataset.name} ready.</div></div>`; };
        document.getElementById('backBtn').onclick = function() { document.getElementById('lobbyView').classList.remove('hidden'); document.getElementById('workspaceView').classList.remove('active'); document.getElementById('backBtn').classList.remove('show'); };

        async function sendMsg() { 
            const inp = document.getElementById('chatInput'), pr = inp.value.trim(); 
            if (!pr && !attach) return; 
            const kd = getKey(); if (!kd) return; 
            const { k, i } = kd; 
            let parts = []; 
            if (attach && attach.type === 'image' && attach.file) { 
                const b64 = await new Promise(res => { const r = new FileReader(); r.onload = e => res(e.target.result.split(',')[1]); r.readAsDataURL(attach.file); }); 
                parts.push({ inline_data: { mime_type: attach.file.type, data: b64 } }); 
                parts.push({ text: pr || "Analyze" }); 
            } else if (attach && attach.type === 'txt' && attach.file) { 
                parts.push({ text: `[File: ${attach.name}]\n${(await attach.file.text()).substring(0, 2000)}\n\n${pr}` }); 
            } else { 
                parts.push({ text: pr }); 
            } 
            let uh = '<div class="message message-user">'; 
            if (attach?.type === 'image' && attach.file) uh += `<img src="${await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(attach.file); })}" style="max-width:70px;border-radius:3px;margin-bottom:2px">`; 
            uh += `<div class="message-text">${pr}</div></div>`; 
            document.getElementById('chatBox').innerHTML += uh; 
            inp.value = ''; attach = null; 
            const tid = 't' + Date.now(); 
            document.getElementById('chatBox').innerHTML += `<div id="${tid}" class="message message-ai"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`; 
            try { 
                const md = document.getElementById('modelSel').value;
                // AMBIL WORKER ACAK DARI 2 URL YANG DIBERI
                const workerUrl = WORKERS[Math.floor(Math.random() * WORKERS.length)];
                const targetUrl = `https://generativelanguage.googleapis.com/v1beta/models/${md}:generateContent?key=${k}`;
                const proxy = `${workerUrl}?url=${encodeURIComponent(targetUrl)}`;
                
                const re = await fetch(proxy, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts }], generationConfig: SPEED_CFG[speed] }) }); 
                document.getElementById(tid)?.remove(); 
                const dt = await re.json(); 
                if (dt.error) { 
                    if (dt.error.message?.includes('quota')) { markKey(i); toast('Key Limit', 'warning'); return; } 
                    throw new Error(dt.error.message); 
                } 
                const tx = dt.candidates?.[0]?.content?.parts?.[0]?.text || 'No response'; 
                document.getElementById('chatBox').innerHTML += `<div class="message message-ai"><div class="message-text">${tx.replace(/\n/g, '<br>')}</div></div>`; 
                msgs++; document.getElementById('msgNum').textContent = msgs; 
                if (user) addDoc(collection(db, 'artifacts', 'virza-v12', 'users', user.uid, 'history'), { prompt: pr, portal: activePortal, timestamp: serverTimestamp() }); 
            } catch (e) { 
                document.getElementById(tid)?.remove(); 
                let errMsg = e.message;
                if (e.message.includes('Failed to fetch')) errMsg = "Network Error (Cek Worker URL)";
                document.getElementById('chatBox').innerHTML += `<div class="message message-ai"><div class="message-text" style="color:var(--danger)">Error: ${errMsg}</div></div>`; 
            } 
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight; 
        }
        document.getElementById('sendBtn').onclick = sendMsg;
        document.getElementById('chatInput').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } };
        document.querySelectorAll('.speed-btn').forEach(b => { b.onclick = function() { document.querySelectorAll('.speed-btn').forEach(x => x.classList.remove('active')); this.classList.add('active'); speed = this.dataset.speed; const c = { fast: 'var(--success)', balanced: 'var(--warning)', quality: 'var(--danger)' }; document.getElementById('modeBadge').innerHTML = `<div style="width:3px;height:3px;background:${c[speed]};border-radius:50%;"></div><span>${speed.charAt(0).toUpperCase() + speed.slice(1)}</span>`; }; });
        document.getElementById('attachBtn').onclick = function(e) { if (!e.target.closest('.attachment-menu')) document.getElementById('attachMenu').classList.toggle('show'); };
        document.getElementById('attachMenu').onclick = function(e) { const btn = e.target.closest('button'); if (!btn) return; document.getElementById('attachMenu').classList.remove('show'); const fi = document.getElementById('fileInput'); fi.accept = btn.dataset.type === 'image' ? 'image/*' : '.txt'; fi.click(); };
        document.getElementById('fileInput').onchange = function(e) { const f = e.target.files[0]; if (!f) return; attach = { type: f.type.startsWith('image') ? 'image' : 'txt', file: f, name: f.name }; toast('File: ' + f.name, 'success'); };
        document.getElementById('refreshProxyBtn').onclick = async function() { toast('Fetching...', 'info'); try { const r = await fetch('https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=6000'); proxies = (await r.text()).split('\n').filter(l => l.includes(':')).slice(0, 25); document.getElementById('proxyNum').textContent = proxies.length; toast(proxies.length + ' ok', 'success'); } catch { toast('Error', 'error'); } };
        document.getElementById('torBtn').onclick = function() { tor = !tor; this.innerHTML = `<i class="fa-solid fa-user-secret"></i> Incognito: ${tor ? 'ON' : 'OFF'}`; this.classList.toggle('tor-active', tor); toast('Incognito ' + (tor ? 'on' : 'off'), 'info'); };
        document.getElementById('historyBtn').onclick = () => document.getElementById('histPanel').classList.add('open'); document.getElementById('closeHist').onclick = () => document.getElementById('histPanel').classList.remove('open');
        document.getElementById('contactBtn').onclick = () => document.getElementById('contactPanel').classList.add('open'); document.getElementById('closeContact').onclick = () => document.getElementById('contactPanel').classList.remove('open');
        document.getElementById('globalBtn').onclick = () => document.getElementById('globalPanel').classList.add('open'); document.getElementById('closeGlobal').onclick = () => document.getElementById('globalPanel').classList.remove('open');
        document.getElementById('clearBtn').onclick = function() { document.getElementById('chatBox').innerHTML = '<div class="message message-ai"><div class="message-text">Cleared.</div></div>'; toast('Cleared', 'success'); };
        async function loadHist() { if (!user) return; try { const sn = await getDocs(query(collection(db, 'artifacts', 'virza-v12', 'users', user.uid, 'history'), orderBy('timestamp', 'desc'), limit(15)); document.getElementById('histList').innerHTML = ''; sn.forEach(d => { const dt = d.data(); const it = document.createElement('div'); it.className = 'history-item'; it.innerHTML = `<div style="font-size:0.35rem;color:var(--accent)">${dt.portal || 'General'}</div><div style="font-size:0.5rem">${dt.prompt}</div>`; it.onclick = () => { document.getElementById('chatInput').value = dt.prompt; document.getElementById('histPanel').classList.remove('open'); }; document.getElementById('histList').appendChild(it); }); } catch {} }
        function initGlobal() { if (!user) return; onSnapshot(query(collection(db, 'chatrooms', 'global', 'messages'), orderBy('timestamp', 'asc'), limit(30)), snap => { const b = document.getElementById('globalBox'); b.innerHTML = ''; snap.forEach(d => { const m = d.data(); b.innerHTML += `<div class="global-msg ${m.uid === user.uid ? 'self' : 'other'}"><div style="font-size:0.35rem;opacity:0.7">${m.name || 'Anon'}</div><div>${m.text}</div></div>`; }); b.scrollTop = b.scrollHeight; }); }
        document.getElementById('sendGlobal').onclick = async function() { const t = document.getElementById('globalInput').value.trim(); if (!t || !user) return; await addDoc(collection(db, 'chatrooms', 'global', 'messages'), { text: t, uid: user.uid, name: user.displayName || user.email?.split('@')[0] || 'Ghost', timestamp: serverTimestamp() }); document.getElementById('globalInput').value = ''; };
        document.getElementById('globalInput').onkeydown = e => { if (e.key === 'Enter') document.getElementById('sendGlobal').click(); };
        document.addEventListener('click', e => { if (!e.target.closest('.attachment-btn')) document.getElementById('attachMenu').classList.remove('show'); });
        setTimeout(() => document.getElementById('refreshProxyBtn').click(), 2000);
    </script>
</body>
</html>
    
                                
