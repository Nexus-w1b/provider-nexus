<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Virza Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #00d4ff;
            --accent-2: #7b2cbf;
            --accent-3: #ff006e;
            --bg-deep: #030014;
            --success: #00ff88;
            --warning: #ffbe0b;
            --danger: #ff006e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg-deep);
            color: #e0e7ff;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
        }

        /* Background */
        .space-bg {
            position: fixed; inset: 0; z-index: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(123, 44, 191, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
        }

        .stars-layer { position: absolute; inset: 0; overflow: hidden; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .shooting-star {
            position: absolute;
            width: 120px; height: 2px;
            background: linear-gradient(90deg, white, transparent);
            animation: shoot 4s ease-in-out infinite;
            opacity: 0;
        }
        @keyframes shoot {
            0% { transform: translateX(0) translateY(0) rotate(-45deg); opacity: 0; }
            5% { opacity: 1; }
            20% { transform: translateX(-250px) translateY(250px) rotate(-45deg); opacity: 0; }
        }

                /* ========== LOADING SCREEN FIX ========== */
        .loading-screen {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: linear-gradient(180deg, #030014 0%, #0a0a1f 50%, #030014 100%);
            transition: opacity 0.5s ease-out;
        }
        .loading-screen.hide { opacity: 0; pointer-events: none; }

        .spaceship-3d {
            position: relative; 
            width: 100px; height: 150px;
            /* Animasi masuk awal, terus float */
            animation: shipFloat 3s ease-in-out infinite, shipEnter 0.8s ease-out forwards;
            transition: transform 0.8s ease-in, opacity 0.8s ease-in;
        }
        /* KELAS BUAT TERBANG KELUAR (dipanggil JS) */
        .spaceship-3d.fly-out {
            transform: translateY(-200vh) scale(0.5); 
            opacity: 0;
        }

        @media (min-width: 768px) { .spaceship-3d { width: 140px; height: 200px; } }

        @keyframes shipEnter {
            0% { transform: translateY(120px) scale(0.3); opacity: 0; }
            70% { transform: translateY(-10px) scale(1.05); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes shipFloat {
            0%, 100% { transform: translateY(0) rotateY(0); }
            50% { transform: translateY(-8px) rotateY(5deg); }
        }

        /* Pesawat Badan & Elemen (Ukuran disesuaikan) */
        .rocket-body {
            position: absolute; left: 50%; top: 35px; transform: translateX(-50%);
            width: 35px; height: 80px;
            background: linear-gradient(90deg, #1e293b, #94a3b8 50%, #1e293b);
            border-radius: 50% 50% 15% 15% / 60% 60% 10% 10%;
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.2);
        }
        @media (min-width: 768px) { .rocket-body { width: 50px; height: 110px; top: 45px; } }

        .rocket-nose {
            position: absolute; left: 50%; top: 0; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-bottom: 35px solid #dc2626;
        }
        @media (min-width: 768px) { .rocket-nose { border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 45px solid #dc2626; } }

        .rocket-window {
            position: absolute; left: 50%; top: 50px; transform: translateX(-50%);
            width: 12px; height: 12px;
            background: radial-gradient(circle, #00d4ff, #0369a1);
            border-radius: 50%; border: 2px solid #334155;
            box-shadow: 0 0 10px var(--accent);
            animation: windowGlow 2s infinite;
        }
        @media (min-width: 768px) { .rocket-window { width: 18px; height: 18px; top: 65px; } }
        @keyframes windowGlow { 0%, 100% { box-shadow: 0 0 10px var(--accent); } 50% { box-shadow: 0 0 20px var(--accent); } }

        .fin-left, .fin-right { position: absolute; bottom: 20px; }
        .fin-left { left: 6px; border-right: 18px solid #b91c1c; border-top: 8px solid transparent; border-bottom: 25px solid transparent; transform: rotate(-10deg); }
        .fin-right { right: 6px; border-left: 18px solid #b91c1c; border-top: 8px solid transparent; border-bottom: 25px solid transparent; transform: rotate(10deg); }
        @media (min-width: 768px) { .fin-left { left: 10px; border-right-width: 25px; } .fin-right { right: 10px; border-left-width: 25px; } }

        .flame {
            position: absolute; left: 50%; bottom: -35px; transform: translateX(-50%);
            width: 20px; height: 40px;
            background: linear-gradient(to top, #ff3300, #ffcc00, #fff);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flicker 0.1s infinite alternate;
            box-shadow: 0 0 15px #ff6600;
        }
        @media (min-width: 768px) { .flame { width: 30px; height: 55px; bottom: -45px; } }
        @keyframes flicker { 0% { transform: translateX(-50%) scaleY(1); } 100% { transform: translateX(-50%) scaleY(1.1); } }

        .loading-text { margin-top: 50px; text-align: center; opacity: 0; animation: fadeIn 0.5s ease-out 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .loading-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem; font-weight: 900; letter-spacing: 0.2em;
            color: var(--accent); text-shadow: 0 0 15px var(--accent);
        }
        @media (min-width: 768px) { .loading-title { font-size: 2rem; } }

        /* Progress Bar 3 Detik (3s) */
        .progress-bar { width: 120px; height: 2px; background: rgba(0, 212, 255, 0.15); border-radius: 2px; margin: 0.6rem auto; overflow: hidden; }
        @media (min-width: 768px) { .progress-bar { width: 180px; height: 3px; margin: 0.8rem auto; } }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); animation: load 3s ease-out forwards; }
        @keyframes load { to { width: 100%; } }
        
        .loading-status {
            font-family: 'Orbitron', sans-serif; font-size: 0.45rem; color: var(--accent); letter-spacing: 0.15em; text-transform: uppercase; margin-top: 0.3rem;
            transition: opacity 0.2s ease-in-out;
        }
        @media (min-width: 768px) { .loading-status { font-size: 0.55rem; } }


        /* ========== AUTH SCREEN ========== */
        .auth-screen {
            position: fixed; inset: 0; z-index: 100;
            display: none; align-items: center; justify-content: center; padding: 1rem;
        }

        .station-panel {
            width: 100%; max-width: 380px; padding: 2rem;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.95), rgba(3, 0, 20, 0.98));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 1.25rem;
            position: relative; overflow: hidden;
        }
        .station-panel::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .input-group { position: relative; margin-bottom: 0.7rem; }
        .input-group i {
            position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%);
            color: var(--accent); opacity: 0.7; font-size: 0.85rem;
        }
        .input-group input {
            width: 100%; padding: 0.65rem 0.8rem 0.65rem 2.3rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.55rem;
            color: white; font-size: 0.8rem;
            outline: none; font-family: 'Rajdhani', sans-serif;
            transition: all 0.3s;
        }
        .input-group input:focus { border-color: var(--accent); box-shadow: 0 0 12px rgba(0, 212, 255, 0.2); }
        .input-group input::placeholder { color: #475569; }

        .btn-primary {
            width: 100%; padding: 0.65rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border: none; border-radius: 0.55rem;
            color: white; font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(0, 212, 255, 0.4); }

        .btn-secondary {
            width: 100%; padding: 0.55rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.55rem;
            color: var(--accent); font-size: 0.7rem;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 0.5rem;
            margin-top: 0.5rem; transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
        }
        .btn-secondary:hover { background: rgba(0, 212, 255, 0.15); }
        .btn-anonymous { background: rgba(0, 255, 136, 0.1); border-color: rgba(0, 255, 136, 0.2); color: var(--success); }
        .btn-anonymous:hover { background: rgba(0, 255, 136, 0.15); }

        .divider { display: flex; align-items: center; margin: 0.7rem 0; }
        .divider span { flex: 1; height: 1px; background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent); }
        .divider p { padding: 0 0.7rem; font-size: 0.55rem; color: #475569; text-transform: uppercase; letter-spacing: 0.15em; }

        .auth-toggle { text-align: center; margin-top: 0.7rem; }
        .auth-toggle button { background: none; border: none; color: var(--accent); font-size: 0.65rem; cursor: pointer; }

        /* ========== MAIN UI ========== */
        .main-ui {
            position: relative; z-index: 10;
            display: none; flex-direction: column; height: 100%;
        }

        .header {
            height: 52px;
            background: rgba(3, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            display: flex; align-items: center;
            justify-content: space-between; padding: 0 0.75rem;
        }

        .back-btn {
            width: 30px; height: 30px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.35rem;
            display: none; align-items: center; justify-content: center;
            color: var(--accent); cursor: pointer;
        }
        .back-btn.show { display: flex; }

        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--warning);
            animation: dotBlink 1s infinite;
        }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); animation: none; }
        @keyframes dotBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .time-display { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; font-weight: 700; }
        .date-display { font-size: 0.5rem; color: #64748b; }

        .gps-indicator {
            display: flex; align-items: center; gap: 3px;
            padding: 2px 6px; background: rgba(0,0,0,0.3);
            border-radius: 8px; font-size: 0.45rem;
        }
        .gps-dot { width: 5px; height: 5px; border-radius: 50%; background: #4a5568; transition: all 0.3s; }
        .gps-dot.active { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .gps-dot.inactive { background: var(--danger); }

        .header-badge {
            padding: 0.15rem 0.4rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.7rem;
            font-size: 0.5rem; color: var(--accent);
        }

        .avatar-btn {
            width: 30px; height: 30px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 700;
            cursor: pointer;
        }
        .settings-btn {
            width: 30px; height: 30px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.35rem;
            display: flex; align-items: center; justify-content: center;
            color: var(--accent); cursor: pointer;
        }

        .main-content { flex: 1; overflow: hidden; position: relative; }

        .lobby-view { position: absolute; inset: 0; overflow-y: auto; padding: 0.75rem; }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.55rem;
        }
        @media (min-width: 480px) { .portal-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .portal-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1024px) { .portal-grid { grid-template-columns: repeat(5, 1fr); } }

        .portal-card {
            padding: 0.7rem;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.7), rgba(3, 0, 20, 0.85));
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 0.7rem; cursor: pointer;
            transition: all 0.25s;
        }
        .portal-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 212, 255, 0.35);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.1);
        }
        .portal-card:active { transform: scale(0.97); }

        .portal-icon {
            width: 32px; height: 32px;
            border-radius: 0.45rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85rem; margin-bottom: 0.3rem;
        }
        .portal-name { font-family: 'Orbitron', sans-serif; font-size: 0.55rem; font-weight: 700; text-transform: uppercase; }
        .portal-desc { font-size: 0.4rem; color: #64748b; margin-top: 0.1rem; }

        .workspace-view {
            position: absolute; inset: 0;
            display: none; flex-direction: column;
        }
        .workspace-view.active { display: flex; }

        .chat-panel { flex: 1; display: flex; flex-direction: column; }

        .chat-header {
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.25);
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            display: flex; align-items: center; justify-content: space-between;
        }

        .chat-box {
            flex: 1; overflow-y: auto; padding: 0.75rem;
            display: flex; flex-direction: column; gap: 0.5rem;
        }

        .message {
            max-width: 85%; padding: 0.5rem 0.65rem;
            border-radius: 0.7rem;
            animation: msgSlide 0.2s ease-out;
        }
        @keyframes msgSlide { from { opacity: 0; transform: translateY(5px); } }
        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 0.7rem 0.7rem 0.15rem 0.7rem;
        }
        .message-ai {
            align-self: flex-start;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 0.7rem 0.7rem 0.7rem 0.15rem;
        }
        .message-text { font-size: 0.7rem; line-height: 1.35; }

        .typing-indicator { display: flex; gap: 0.15rem; padding: 0.3rem 0; }
        .typing-indicator span {
            width: 4px; height: 4px;
            background: var(--accent); border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

        .chat-input-area {
            padding: 0.5rem;
            background: rgba(3, 0, 20, 0.95);
            border-top: 1px solid rgba(0, 212, 255, 0.08);
        }

        .chat-input-row { display: flex; gap: 0.3rem; }

        .attachment-btn {
            width: 32px; height: 32px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.35rem;
            color: var(--accent); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            position: relative; transition: all 0.3s;
        }
        .attachment-btn.active { background: rgba(0, 255, 136, 0.12); color: var(--success); }

        .attachment-menu {
            position: absolute; bottom: 100%; left: 0;
            margin-bottom: 0.3rem;
            background: rgba(10, 10, 31, 0.98);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.45rem; padding: 0.2rem;
            display: none; flex-direction: column;
            min-width: 120px; z-index: 100;
        }
        .attachment-menu.show { display: flex; }
        .attachment-menu button {
            display: flex; align-items: center; gap: 0.35rem;
            padding: 0.35rem 0.45rem;
            background: transparent; border: none;
            border-radius: 0.3rem;
            color: #e0e7ff; font-size: 0.6rem;
            cursor: pointer; text-align: left;
            font-family: 'Rajdhani', sans-serif;
        }
        .attachment-menu button:hover { background: rgba(0, 212, 255, 0.1); }

        .chat-textarea {
            flex: 1; padding: 0.45rem;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.12);
            border-radius: 0.45rem;
            color: white; font-size: 0.7rem;
            outline: none; resize: none; max-height: 70px;
            font-family: 'Rajdhani', sans-serif;
        }
        .chat-textarea:focus { border-color: var(--accent); }

        .send-btn {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border: none; border-radius: 0.35rem;
            color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .speed-row {
            display: flex; align-items: center; justify-content: center;
            gap: 0.3rem; margin-top: 0.3rem;
        }
        .speed-btn {
            padding: 0.15rem 0.4rem;
            border-radius: 0.7rem;
            font-size: 0.45rem; font-weight: 700;
            text-transform: uppercase;
            border: 1px solid; background: transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .speed-btn.fast { color: var(--success); border-color: rgba(0, 255, 136, 0.25); }
        .speed-btn.balanced { color: var(--warning); border-color: rgba(255, 190, 11, 0.25); }
        .speed-btn.quality { color: var(--danger); border-color: rgba(255, 0, 110, 0.25); }
        .speed-btn.active { box-shadow: 0 0 10px currentColor; }

        /* ========== SIDEBAR ========== */
        .sidebar {
            position: fixed; inset-y: 0; right: 0;
            width: 290px; max-width: 85vw;
            background: linear-gradient(180deg, rgba(10, 10, 31, 0.98), rgba(3, 0, 20, 0.99));
            border-left: 1px solid rgba(0, 212, 255, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            display: flex; flex-direction: column;
            touch-action: pan-y;
        }
        .sidebar.open { transform: translateX(0); }

        .sidebar-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.08);
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem; font-weight: 800; text-transform: uppercase;
        }
        .sidebar-title span { color: var(--accent); }
        .sidebar-close {
            width: 26px; height: 26px;
            background: rgba(0, 212, 255, 0.1);
            border: none; border-radius: 50%;
            color: var(--accent); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .sidebar-body {
            flex: 1; overflow-y: auto; padding: 0.65rem;
            display: flex; flex-direction: column; gap: 0.6rem;
        }

        .sidebar-section {
            padding: 0.65rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.08);
            border-radius: 0.45rem;
        }
        .sidebar-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.55rem; font-weight: 700;
            text-transform: uppercase; margin-bottom: 0.45rem;
            display: flex; align-items: center; gap: 0.3rem;
        }
        .sidebar-section-title i { color: var(--accent); font-size: 0.6rem; }

        .key-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.12rem; margin-top: 0.3rem; }
        .key-dot { aspect-ratio: 1; border-radius: 2px; transition: all 0.3s; }
        .key-dot.active { background: var(--success); box-shadow: 0 0 4px var(--success); }
        .key-dot.exhausted { background: var(--danger); opacity: 0.5; }
        .key-dot.standby { background: rgba(0, 212, 255, 0.3); }

        .proxy-actions { display: flex; flex-direction: column; gap: 0.25rem; }
        .proxy-btn {
            padding: 0.4rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 0.3rem;
            color: var(--accent); font-size: 0.5rem; font-weight: 600;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 0.3rem;
            font-family: 'Rajdhani', sans-serif; transition: all 0.3s;
        }
        .proxy-btn:hover { background: rgba(0, 212, 255, 0.15); }
        .proxy-btn.tor-active { background: rgba(123, 44, 191, 0.15); color: var(--accent-2); }

        .quick-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.3rem; }
        .stat-card {
            padding: 0.45rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.06);
            border-radius: 0.3rem; text-align: center;
        }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; font-weight: 800; color: var(--accent); }
        .stat-label { font-size: 0.4rem; color: #64748b; text-transform: uppercase; }

        .sidebar-actions { display: flex; flex-direction: column; gap: 0.25rem; }
        .action-btn {
            padding: 0.45rem;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.3rem;
            color: var(--accent); font-size: 0.55rem; font-weight: 600;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 0.3rem;
            font-family: 'Rajdhani', sans-serif; transition: all 0.3s;
        }
        .action-btn:hover { background: rgba(0, 212, 255, 0.12); }
        .action-btn.danger { background: rgba(255, 0, 110, 0.08); border-color: rgba(255, 0, 110, 0.15); color: var(--danger); }

        .sidebar-footer { padding: 0.65rem; border-top: 1px solid rgba(0, 212, 255, 0.08); }
        .logout-btn {
            width: 100%; padding: 0.5rem;
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 0.35rem;
            color: var(--danger);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.55rem; font-weight: 700;
            text-transform: uppercase; cursor: pointer;
        }

        /* Panels */
        .panel-overlay {
            position: fixed; inset: 0; z-index: 900;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center; padding: 1rem;
        }
        .panel-overlay.open { display: flex; }
        .panel-content {
            width: 100%; max-width: 380px;
            background: linear-gradient(145deg, rgba(10, 10, 31, 0.98), rgba(3, 0, 20, 0.99));
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.7rem; padding: 1.1rem;
        }
        .panel-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 0.9rem;
        }
        .panel-title { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.8rem; }

        .global-panel .panel-content { max-width: 420px; height: 65vh; display: flex; flex-direction: column; }
        .global-chat-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.4rem; }
        .global-msg {
            padding: 0.45rem 0.55rem; border-radius: 0.45rem;
            max-width: 80%; font-size: 0.65rem;
        }
        .global-msg.self { align-self: flex-end; background: rgba(0, 212, 255, 0.15); }
        .global-msg.other { align-self: flex-start; background: rgba(255, 255, 255, 0.05); }
        .global-input-area {
            display: flex; gap: 0.3rem; margin-top: 0.5rem; padding-top: 0.5rem;
            border-top: 1px solid rgba(0, 212, 255, 0.08);
        }
        .global-input {
            flex: 1; padding: 0.45rem;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 212, 255, 0.12);
            border-radius: 0.45rem;
            color: white; font-size: 0.65rem;
            outline: none;
        }

        .contact-btn {
            padding: 0.75rem;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 0.5rem;
            color: white; font-size: 0.7rem; font-weight: 600;
            cursor: pointer; display: flex;
            align-items: center; gap: 0.6rem;
            text-decoration: none; margin-bottom: 0.5rem;
        }
        .contact-btn:hover { background: rgba(0, 212, 255, 0.12); }
        .contact-btn i { font-size: 1rem; }
        .contact-btn.email i { color: var(--accent); }
        .contact-btn.whatsapp i { color: #25D366; }

        .history-item {
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 212, 255, 0.08);
            border-radius: 0.35rem; margin-bottom: 0.3rem;
            cursor: pointer;
        }
        .history-item:hover { background: rgba(0, 212, 255, 0.08); }

        /* Toast */
        .toast {
            position: fixed; bottom: 55px; left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            border-radius: 0.7rem; font-size: 0.6rem; font-weight: 600;
            z-index: 5000; animation: toastIn 0.2s ease-out;
        }
        .toast.success { background: rgba(0, 255, 136, 0.95); color: #000; }
        .toast.error { background: rgba(255, 0, 110, 0.95); color: #fff; }
        .toast.warning { background: rgba(255, 190, 11, 0.95); color: #000; }
        .toast.info { background: rgba(0, 212, 255, 0.95); color: #000; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } }

        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="space-bg">
        <div class="stars-layer" id="starsLayer"></div>
        <div class="shooting-star" style="top: 20%; right: 18%;"></div>
        <div class="shooting-star" style="top: 50%; right: 35%; animation-delay: 2s;"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="stars-layer" id="loadingStars"></div>
        <div class="spaceship-3d">
            <div class="rocket-nose"></div>
            <div class="rocket-body">
                <div class="rocket-window"></div>
                <div class="rocket-stripe"></div>
            </div>
            <div class="fin-left"></div>
            <div class="fin-right"></div>
            <div class="rocket-engine"></div>
            <div class="flame"></div>
        </div>
        <div class="loading-text">
            <div class="loading-title">NEXUS</div>
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <div class="loading-status" id="loadingStatus">Virza System</div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="station-panel">
            <div style="text-align:center;margin-bottom:1rem;">
                <i class="fa-solid fa-rocket" style="font-size:1.5rem;color:var(--accent);"></i>
                <h1 style="font-family:'Orbitron';font-size:1.3rem;font-weight:900;margin-top:0.4rem;">NEXUS <span style="color:var(--accent)">SPAN</span></h1>
                <p style="font-size:0.5rem;color:#64748b;letter-spacing:0.3em;margin-top:0.2rem;">VIRZA ACCESS</p>
            </div>
            
            <div class="input-group"><i class="fa-solid fa-envelope"></i><input type="email" id="emailInput" placeholder="Email Address"></div>
            <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="passInput" placeholder="Security Code"></div>
            
            <button class="btn-primary" id="authBtn">Initialize Connection</button>
            
            <div class="divider"><span></span><p>or</p><span></span></div>
            
            <button class="btn-secondary" id="googleBtn"><i class="fa-brands fa-google"></i> Google </button>
            <button class="btn-secondary btn-anonymous" id="anonBtn"><i class="fa-solid fa-user-secret"></i> guest</button>
            
            <div class="auth-toggle"><button id="authToggleBtn">Belum punya akun? daftar</button></div>
        </div>
    </div>

    <!-- Main UI -->
    <div id="mainUI" class="main-ui">
        <header class="header">
            <div style="display:flex;align-items:center;gap:0.5rem;">
                <button class="back-btn" id="backBtn"><i class="fa-solid fa-arrow-left"></i></button>
                <div>
                    <div style="display:flex;align-items:center;gap:0.25rem;">
                        <div class="status-dot" id="statusDot"></div>
                        <span style="font-size:0.45rem;color:#64748b;" id="statusText">CONNECTING</span>
                    </div>
                    <div class="time-display" id="timeDisplay">--:--:--</div>
                    <div class="date-display" id="dateDisplay">Loading...</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:0.35rem;">
                <div class="gps-indicator">
                    <div class="gps-dot" id="gpsDot"></div>
                    <span id="gpsText">GPS</span>
                </div>
                <div class="header-badge" id="keyBadge"> Keys Active</div>
                <button class="avatar-btn" id="avatarBtn">V</button>
                <button class="settings-btn" id="settingsBtn"><i class="fa-solid fa-sliders"></i></button>
            </div>
        </header>

        <main class="main-content">
            <div id="lobbyView" class="lobby-view no-scrollbar">
                <div style="max-width:850px;margin:0 auto;">
                    <div style="text-align:center;margin-bottom:0.8rem;">
                        <h2 style="font-family:'Orbitron';font-size:1.2rem;">Welcome, <span style="color:var(--accent)" id="userName">NPC </span></h2>
                    </div>
                    <div style="position:relative;margin-bottom:0.8rem;">
                        <i class="fa-solid fa-search" style="position:absolute;left:0.7rem;top:50%;transform:translateY(-50%);color:var(--accent);opacity:0.6;font-size:0.75rem;"></i>
                        <input type="text" class="chat-textarea" id="searchInput" placeholder="Search portals..." style="padding-left:2rem;padding:0.4rem 0.4rem 0.4rem 2rem;">
                    </div>
                    <div class="portal-grid" id="portalGrid"></div>
                </div>
            </div>

            <div id="workspaceView" class="workspace-view">
                <div class="chat-panel">
                    <div class="chat-header">
                        <div style="display:flex;align-items:center;gap:0.4rem;">
                            <div id="chatPortalIcon" style="width:26px;height:26px;border-radius:0.35rem;display:flex;align-items:center;justify-content:center;font-size:0.75rem;"><i class="fa-solid fa-robot"></i></div>
                            <div>
                                <div style="font-family:'Orbitron';font-size:0.65rem;font-weight:700;" id="chatPortalName">Smart AI</div>
                                <div style="font-size:0.45rem;color:#64748b;" id="chatPortalDesc">Active</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.2rem;padding:0.2rem 0.4rem;background:rgba(0,0,0,0.35);border-radius:0.6rem;font-size:0.45rem;" id="modeBadge">
                            <div style="width:4px;height:4px;background:var(--success);border-radius:50%;"></div><span>Flash</span>
                        </div>
                    </div>
                    <div class="chat-box no-scrollbar" id="chatBox">
                        <div class="message message-ai"><div class="message-text">Portal activated. Ready to assist.</div></div>
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-row">
                            <div class="attachment-btn" id="attachBtn">
                                <i class="fa-solid fa-plus"></i>
                                <div class="attachment-menu" id="attachMenu">
                                    <button data-type="image"><i class="fa-solid fa-image" style="color:var(--success)"></i><span>Photo</span></button>
                                    <button data-type="txt"><i class="fa-solid fa-file-lines" style="color:var(--accent)"></i><span>TXT File</span></button>
                                </div>
                            </div>
                            <textarea class="chat-textarea" id="chatInput" placeholder="Type command..." rows="1"></textarea>
                            <button class="send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        <div class="speed-row">
                            <span style="font-size:0.45rem;color:#64748b;">Speed:</span>
                            <button class="speed-btn fast active" data-speed="fast">Fast</button>
                            <button class="speed-btn balanced" data-speed="balanced">Balanced</button>
                            <button class="speed-btn quality" data-speed="quality">Quality</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Vault <span>Control</span></h3>
            <button class="sidebar-close" id="sidebarClose"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="sidebar-body no-scrollbar">
            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-microchip"></i> Nexus AI</div>
                <select id="modelSel" class="chat-textarea" style="padding:0.35rem;font-size:0.55rem;">
                    <option value="gemini-1.5-flash">1.5 Flash</option>
                    <option value="gemini-1.5-flash-8b">1.5 Flash-8B</option>
                    <option value="gemini-1.5-pro">1.5 Pro</option>
                </select>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-key"></i> API Key </div>
                <div style="font-size:0.5rem;margin-bottom:0.2rem;">Active: <strong id="activeKeyNum">null</strong>/null</div>
                <div class="key-grid" id="keyGrid"></div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-network-wired"></i> Proxy Network</div>
                <div class="proxy-actions">
                    <button class="proxy-btn" id="refreshProxyBtn"><i class="fa-solid fa-rotate"></i> Refresh (<span id="proxyNum">0</span>)</button>
                    <button class="proxy-btn" id="torBtn"><i class="fa-solid fa-user-secret"></i> Incognito: OFF</button>
                    <button class="proxy-btn" id="anonSidebarBtn"><i class="fa-solid fa-incognito"></i> Guest Login</button>
                </div>
                <p style="font-size:0.4rem;color:#64748b;margin-top:0.35rem;">Proxy auto-refresh tiap 30 menit</p>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title"><i class="fa-solid fa-chart-line"></i> Stats</div>
                <div class="quick-stats">
                    <div class="stat-card"><div class="stat-value" id="msgNum">0</div><div class="stat-label">Messages</div></div>
                    <div class="stat-card"><div class="stat-value" id="reqNum">0</div><div class="stat-label">Requests</div></div>
                </div>
            </div>

            <div class="sidebar-actions">
                <button class="action-btn" id="globalBtn"><i class="fa-solid fa-users"></i> Global Lounge</button>
                <button class="action-btn" id="historyBtn"><i class="fa-solid fa-clock-rotate-left"></i> History</button>
                <button class="action-btn" id="clearBtn"><i class="fa-solid fa-broom"></i> Clear Chat</button>
                <button class="action-btn" id="contactBtn"><i class="fa-solid fa-envelope"></i> Contact Dev</button>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Terminate</button>
        </div>
    </aside>

    <!-- History Panel -->
    <div class="panel-overlay" id="histPanel">
        <div class="panel-content">
            <div class="panel-header">
                <h3 class="panel-title">History</h3>
                <button class="sidebar-close" id="closeHist"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="histList" style="max-height:45vh;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Contact Panel -->
    <div class="panel-overlay" id="contactPanel">
        <div class="panel-content">
            <div class="panel-header">
                <h3 class="panel-title">Contact Developer</h3>
                <button class="sidebar-close" id="closeContact"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <a href="mailto:visi4ura@gmail.com?subject=Virza%20Nexus%20Support&body=Hello%20Developer%2C%0A%0AI%20need%20assistance%20with%20Virza%20Nexus.%0A%0A%5BPlease%20describe%20your%20issue%5D%0A%0ABest%20regards" class="contact-btn email">
                <i class="fa-solid fa-envelope"></i>
                <div><div style="font-weight:700;font-size:0.6rem;">Email Support</div><div style="font-size:0.55rem;color:#64748b;">visi4ura@gmail.com</div></div>
            </a>
            <a href="https://wa.me/6285715818953?text=Hello%20Developer%2C%0A%0AI%20am%20using%20Virza%20Nexus%20and%20need%20assistance.%0A%0A%5BPlease%20describe%20your%20issue%5D" target="_blank" class="contact-btn whatsapp">
                <i class="fa-brands fa-whatsapp"></i>
                <div><div style="font-weight:700;font-size:0.6rem;">WhatsApp</div><div style="font-size:0.55rem;color:#64748b;">+62 882-2587-9928</div></div>
            </a>
        </div>
    </div>

    <!-- Global Chat Panel -->
    <div class="panel-overlay global-panel" id="globalPanel">
        <div class="panel-content">
            <div class="panel-header">
                <h3 class="panel-title" style="color:var(--accent)"><i class="fa-solid fa-users" style="margin-right:0.4rem"></i>Global Lounge</h3>
                <button class="sidebar-close" id="closeGlobal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="global-chat-box no-scrollbar" id="globalBox"></div>
            <div class="global-input-area">
                <input type="text" class="global-input" id="globalInput" placeholder="Chat with others...">
                <button class="send-btn" id="sendGlobal"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept="image/*,.txt">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const fbConfig = {
            apiKey: "AIzaSyBK-MehTTzURY5jT5stH363Y5_WE4iy-XA",
            authDomain: "volca-tools.firebaseapp.com",
            projectId: "volca-tools",
            storageBucket: "volca-tools.firebasestorage.app",
            messagingSenderId: "262525907487",
            appId: "1:262525907487:web:4abc37fa3b583223569b2a"
        };

        const app = initializeApp(fbConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let user = null;
        let attach = null;
        let speed = 'fast';
        let keyIdx = 0;
        let exhausted = new Set();
        let proxies = [];
        let tor = false;
        let msgs = 0, reqs = 0;
        let activePortal = 'General';
        let isLogin = true;

        const KEYS = [
            "AIzaSyDkUSuxeVnUHUzkANYePkrJMOTeC8Gx71E",
            "AIzaSyAAtWkmgIQBhJIbsuQAx_y4l_MB2OX1UGs"
        ];

        const SPEED_CFG = {
            fast: { temperature: 0.5, maxOutputTokens: 1024 },
            balanced: { temperature: 0.7, maxOutputTokens: 2048 },
            quality: { temperature: 0.9, maxOutputTokens: 4096 }
        };

        const portals = [
            {id:'smart',name:'Smart AI',ic:'fa-brain',c:'#34d399',desc:'General chat'},
            {id:'code',name:'Architect',ic:'fa-code',c:'#818cf8',desc:'Code builder'},
            {id:'img',name:'Image HD',ic:'fa-image',c:'#f472b6',desc:'Create visuals'},
            {id:'vision',name:'Vision Pro',ic:'fa-eye',c:'#fbbf24',desc:'Analyze images'},
            {id:'web',name:'Web Weaver',ic:'fa-globe',c:'#60a5fa',desc:'Build websites'},
            {id:'cyber',name:'Cyber Guard',ic:'fa-shield',c:'#f87171',desc:'Security'},
            {id:'math',name:'Quantum',ic:'fa-calculator',c:'#a78bfa',desc:'Math'},
            {id:'seo',name:'SEO Master',ic:'fa-magnifying-glass',c:'#2dd4bf',desc:'Optimize'},
            {id:'data',name:'Data Miner',ic:'fa-database',c:'#94a3b8',desc:'Data'},
            {id:'social',name:'Social Ads',ic:'fa-hashtag',c:'#fb7185',desc:'Marketing'},
            {id:'vid',name:'Motion AI',ic:'fa-film',c:'#fb923c',desc:'Video'},
            {id:'audio',name:'Sonic Wave',ic:'fa-music',c:'#4ade80',desc:'Audio'},
            {id:'logo',name:'Brand AI',ic:'fa-pen-nib',c:'#e879f9',desc:'Branding'},
            {id:'lang',name:'Polyglot',ic:'fa-language',c:'#818cf8',desc:'Translate'},
            {id:'bug',name:'Debug Sys',ic:'fa-bug',c:'#ef4444',desc:'Fix bugs'},
            {id:'cloud',name:'Cloud Drive',ic:'fa-cloud',c:'#38bdf8',desc:'Cloud'},
            {id:'sec',name:'Vault Pro',ic:'fa-lock',c:'#fbbf24',desc:'Security'},
            {id:'write',name:'Ghost Writer',ic:'fa-book',c:'#c084fc',desc:'Content'},
            {id:'game',name:'Game Dev',ic:'fa-gamepad',c:'#f472b6',desc:'Games'},
            {id:'law',name:'Law Logic',ic:'fa-gavel',c:'#fca5a5',desc:'Legal'},
            {id:'health',name:'Medi AI',ic:'fa-heart-pulse',c:'#ef4444',desc:'Health'},
            {id:'finance',name:'Fin AI',ic:'fa-chart-pie',c:'#22c55e',desc:'Finance'},
            {id:'edu',name:'Edu AI',ic:'fa-graduation-cap',c:'#3b82f6',desc:'Learning'},
            {id:'travel',name:'Travel AI',ic:'fa-plane',c:'#06b6d4',desc:'Trips'},
            {id:'recipe',name:'Chef AI',ic:'fa-utensils',c:'#f97316',desc:'Recipes'}
        ];

        // UTILS
        function toast(m, t = 'success') {
            const e = document.querySelector('.toast');
            if (e) e.remove();
            const d = document.createElement('div');
            d.className = 'toast ' + t;
            d.textContent = m;
            document.body.appendChild(d);
            setTimeout(() => d.remove(), 2500);
        }

        // STARS
        function makeStars(el, n) {
            for (let i = 0; i < n; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.cssText = `left:${Math.random() * 100}%;top:${Math.random() * 100}%;width:${Math.random() * 2 + 1}px;height:${Math.random() * 2 + 1}px;animation-delay:${Math.random() * 3}s`;
                el.appendChild(s);
            }
        }

        

        // KEY GRID
        function updKeys() {
            const act = KEYS.length - exhausted.size;
            document.getElementById('activeKeyNum').textContent = act;
            document.getElementById('keyBadge').textContent = act + ' Keys';
            document.getElementById('keyGrid').innerHTML = KEYS.map((_, i) => {
         // LOADING LOGIC: 3 Detik, Text Transisi, Pesawat Terbang
        function runLoad() {
            const bar = document.querySelector('.progress-fill');
            const rocket = document.querySelector('.spaceship-3d');
            const statusText = document.getElementById('loadingStatus');
            const loadingScreen = document.getElementById('loadingScreen');
            const authScreen = document.getElementById('authScreen');

            const duration = 3000; )
            bar.style.animation = 'none';
            bar.offsetHeight; 
            bar.style.animation = `load ${duration}ms ease-out forwards`;

            // Queue text berubah tiap 1 detik
            const statuses = [
                { time: 100, text: "Initializing..." },
                { time: 1100, text: "Connecting..." },
                { time: 2100, text: "Systems Ready" },
                { time: 2800, text: "LAUNCH!" }
            ];

            statuses.forEach(item => {
                setTimeout(() => {
                    statusText.style.opacity = 0; // Fade out
                    setTimeout(() => {
                        statusText.textContent = item.text;
                        statusText.style.opacity = 1; // Fade in
                    }, 100);
                }, item.time);
            });

            // Saat bar penuh (3 detik) -> Pesawat terbang
            setTimeout(() => {
                rocket.classList.add('fly-out'); // CSS class yang bikin pesawat terbang ke atas
                
                // Tunggu 0.8 detik (waktu pesawat keluar layar)
                setTimeout(() => {
                    loadingScreen.classList.add('hide');
                    authScreen.style.display = 'flex';
                }, 800);

            }, duration);
        }               let c = 'key-dot standby';
                if (i === keyIdx && !exhausted.has(i)) c = 'key-dot active';
                else if (exhausted.has(i)) c = 'key-dot exhausted';
                return `<div class="${c}"></div>`;
            }).join('');
        }
        updKeys();

        function getKey() {
            let a = 0;
            while (a < KEYS.length) {
                if (!exhausted.has(keyIdx)) { updKeys(); return { k: KEYS[keyIdx], i: keyIdx }; }
                keyIdx = (keyIdx + 1) % KEYS.length;
                a++;
            }
            toast('All keys limited', 'error');
            return null;
        }

        function markKey(i) {
            exhausted.add(i);
            keyIdx = (i + 1) % KEYS.length;
            updKeys();
            toast('Key ' + (i + 1) + ' limited', 'warning');
        }

        // GPS
        function checkGPS() {
            if (!navigator.geolocation) {
                document.getElementById('gpsDot').classList.add('inactive');
                document.getElementById('gpsText').textContent = 'N/A';
                return;
            }
            navigator.geolocation.getCurrentPosition(
                () => { document.getElementById('gpsDot').classList.add('active'); document.getElementById('gpsText').textContent = 'ON'; },
                () => { document.getElementById('gpsDot').classList.add('inactive'); document.getElementById('gpsText').textContent = 'OFF'; },
                { timeout: 5000 }
            );
        }

        // TIME + TIMEZONE
        function updTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset();
            let zone = '';
            if (offset === -420) zone = 'WIB';
            else if (offset === -480) zone = 'WITA';
            else if (offset === -540) zone = 'WIT';
            else zone = Intl.DateTimeFormat().resolvedOptions().timeZone.split('/').pop();
            
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' }) + ' ' + zone;
        }
        setInterval(updTime, 1000);
        updTime();

        // AUTH
        onAuthStateChanged(auth, u => {
            if (u) {
                user = u;
                const n = u.displayName || u.email?.split('@')[0] || 'Guest';
                document.getElementById('userName').textContent = n.toUpperCase();
                document.getElementById('avatarBtn').textContent = n[0].toUpperCase();
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainUI').style.display = 'flex';
                document.getElementById('statusDot').classList.add('online');
                document.getElementById('statusText').textContent = 'ONLINE';
                checkGPS();
                loadHist();
                initGlobal();
            }
        });

        document.getElementById('authBtn').onclick = () => {
            const e = document.getElementById('emailInput').value.trim();
            const p = document.getElementById('passInput').value;
            if (!e || !p) { toast('Fill fields', 'error'); return; }
            const fn = isLogin ? signInWithEmailAndPassword : createUserWithEmailAndPassword;
            fn(auth, e, p).catch(er => toast(er.message, 'error'));
        };

        document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => toast(e.message, 'error'));
        
        document.getElementById('anonBtn').onclick = () => handleAnonLogin();
        document.getElementById('anonSidebarBtn').onclick = () => handleAnonLogin();

        function handleAnonLogin() {
            signInAnonymously(auth).catch(() => {
                user = { uid: 'guest_' + Math.random().toString(36).substr(2, 8), isAnonymous: true };
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainUI').style.display = 'flex';
                toast('Guest mode', 'info');
            });
        }

        document.getElementById('authToggleBtn').onclick = () => {
            isLogin = !isLogin;
            document.getElementById('authToggleBtn').textContent = isLogin ? 'Belum punya akun? daftar' : 'sudah punya akun? Login';
            document.getElementById('authBtn').textContent = isLogin ? 'Initialize Connection' : 'daftar pengguna';
        };

        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        // SIDEBAR + SWIPE
        const sidebar = document.getElementById('sidebar');
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isDragging = false;

        function toggleSidebar() {
            sidebar.classList.toggle('open');
        }

        document.getElementById('settingsBtn').onclick = toggleSidebar;
        document.getElementById('avatarBtn').onclick = toggleSidebar;
        document.getElementById('sidebarClose').onclick = toggleSidebar;

        // Swipe to open
        document.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            if (touchStartX > window.innerWidth - 30 && !sidebar.classList.contains('open')) {
                isDragging = true;
            }
        }, { passive: true });

        document.addEventListener('touchmove', e => {
            if (!isDragging) return;
            touchCurrentX = e.touches[0].clientX;
            const diff = touchStartX - touchCurrentX;
            if (diff < -50) {
                sidebar.classList.add('open');
                isDragging = false;
            }
        }, { passive: true });

        document.addEventListener('touchend', () => {
            isDragging = false;
        });

        // Swipe inside sidebar to close
        sidebar.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
        }, { passive: true });

        sidebar.addEventListener('touchmove', e => {
            touchCurrentX = e.touches[0].clientX;
            const diff = touchStartX - touchCurrentX;
            if (diff > 80) {
                sidebar.classList.remove('open');
            }
        }, { passive: true });

        // PORTALS
        function renderP(d) {
            document.getElementById('portalGrid').innerHTML = d.map(p => `
                <div class="portal-card" data-id="${p.id}" data-name="${p.name}" data-ic="${p.ic}" data-c="${p.c}">
                    <div class="portal-icon" style="background:${p.c}18;color:${p.c};border:1px solid ${p.c}35"><i class="fa-solid ${p.ic}"></i></div>
                    <div class="portal-name">${p.name}</div>
                    <div class="portal-desc">${p.desc}</div>
                </div>
            `).join('');
        }
        renderP(portals);

        document.getElementById('searchInput').oninput = function() {
            const q = this.value.toLowerCase();
            renderP(portals.filter(p => p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q)));
        };

        document.getElementById('portalGrid').onclick = function(e) {
            const card = e.target.closest('.portal-card');
            if (!card) return;
            activePortal = card.dataset.name;
            document.getElementById('lobbyView').classList.add('hidden');
            document.getElementById('workspaceView').classList.add('active');
            document.getElementById('backBtn').classList.add('show');
            document.getElementById('chatPortalName').textContent = card.dataset.name;
            document.getElementById('chatPortalIcon').innerHTML = `<i class="fa-solid ${card.dataset.ic}"></i>`;
            document.getElementById('chatPortalIcon').style.background = card.dataset.c + '18';
            document.getElementById('chatPortalIcon').style.color = card.dataset.c;
            document.getElementById('chatBox').innerHTML = `<div class="message message-ai"><div class="message-text">${card.dataset.name} activated. Ready.</div></div>`;
        };

        document.getElementById('backBtn').onclick = function() {
            document.getElementById('lobbyView').classList.remove('hidden');
            document.getElementById('workspaceView').classList.remove('active');
            document.getElementById('backBtn').classList.remove('show');
        };

        // CHAT
        async function sendMsg() {
            const inp = document.getElementById('chatInput');
            const pr = inp.value.trim();
            if (!pr && !attach) return;
            const kd = getKey();
            if (!kd) return;
            const { k, i } = kd;

            let parts = [];
            if (attach && attach.type === 'image' && attach.file) {
                const b64 = await new Promise(res => { const r = new FileReader(); r.onload = e => res(e.target.result.split(',')[1]); r.readAsDataURL(attach.file); });
                parts.push({ inline_data: { mime_type: attach.file.type, data: b64 } });
                parts.push({ text: pr || "Analyze this" });
            } else if (attach && attach.type === 'txt' && attach.file) {
                const txt = await attach.file.text();
                parts.push({ text: `[File: ${attach.name}]\n${txt.substring(0, 3000)}\n\n${pr}` });
            } else {
                parts.push({ text: pr });
            }

            let uh = '<div class="message message-user">';
            if (attach?.type === 'image' && attach.file) {
                const id = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(attach.file); });
                uh += `<img src="${id}" style="max-width:100px;border-radius:5px;margin-bottom:3px">`;
            }
            uh += `<div class="message-text">${pr}</div></div>`;
            document.getElementById('chatBox').innerHTML += uh;

            inp.value = '';
            attach = null;

            const tid = 't' + Date.now();
            document.getElementById('chatBox').innerHTML += `<div id="${tid}" class="message message-ai"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;

        try {
                const md = document.getElementById('modelSel').value;
                const WORKER = "https://nexus.visiaura.workers.dev";
                const target = `https://generativelanguage.googleapis.com/v1beta/models/${md}:generateContent?key=${k}`;
                const url = `${WORKER}?url=${encodeURIComponent(target)}`;

                const re = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: SPEED_CFG[speed] })
                });
                document.getElementById(tid)?.remove();
                const dt = await re.json();
                if (dt.error) {
                    if (dt.error.message?.includes('quota')) { markKey(i); toast('Key limited', 'warning'); return; }
                    throw new Error(dt.error.message);
                }
                const tx = dt.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
                document.getElementById('chatBox').innerHTML += `<div class="message message-ai"><div class="message-text">${tx.replace(/\n/g, '<br>')}</div></div>`;
                msgs++;
                document.getElementById('msgNum').textContent = msgs;
                if (user) addDoc(collection(db, 'artifacts', 'virza-v12', 'users', user.uid, 'history'), { prompt: pr, portal: activePortal, timestamp: serverTimestamp() });
            } catch (e) {
                document.getElementById(tid)?.remove();
                document.getElementById('chatBox').innerHTML += `<div class="message message-ai"><div class="message-text" style="color:var(--danger)">Error: ${e.message}</div></div>`;
            }
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        }

        document.getElementById('sendBtn').onclick = sendMsg;
        document.getElementById('chatInput').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } };

        // SPEED
        document.querySelectorAll('.speed-btn').forEach(b => {
            b.onclick = function() {
                document.querySelectorAll('.speed-btn').forEach(x => x.classList.remove('active'));
                this.classList.add('active');
                speed = this.dataset.speed;
                const colors = { fast: 'var(--success)', balanced: 'var(--warning)', quality: 'var(--danger)' };
                document.getElementById('modeBadge').innerHTML = `<div style="width:4px;height:4px;background:${colors[speed]};border-radius:50%;"></div><span>${speed.charAt(0).toUpperCase() + speed.slice(1)}</span>`;
            };
        });

        // ATTACH
        document.getElementById('attachBtn').onclick = function(e) {
            if (!e.target.closest('.attachment-menu')) {
                document.getElementById('attachMenu').classList.toggle('show');
            }
        };

        document.getElementById('attachMenu').onclick = function(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            document.getElementById('attachMenu').classList.remove('show');
            const type = btn.dataset.type;
            const fi = document.getElementById('fileInput');
            fi.accept = type === 'image' ? 'image/*' : '.txt';
            fi.click();
        };

        document.getElementById('fileInput').onchange = function(e) {
            const f = e.target.files[0];
            if (!f) return;
            attach = { type: f.type.startsWith('image') ? 'image' : 'txt', file: f, name: f.name };
            toast('File: ' + f.name, 'success');
        };

        // PROXY (JAMRIMODS INTEGRATED)
        document.getElementById('refreshProxyBtn').onclick = async function() {
            toast('memulai...', 'info');
            try {
                const r = await fetch('https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=10000');
                const t = await r.text();
                proxies = t.split('\n').filter(l => l.includes(':')).map(l => l.trim()).slice(0, 50);
                document.getElementById('proxyNum').textContent = proxies.length;
                toast(proxies.length + ' proxies', 'success');
            } catch { toast('Proxy error', 'error'); }
        };

        document.getElementById('torBtn').onclick = function() {
            tor = !tor;
            this.innerHTML = `<i class="fa-solid fa-user-secret"></i> Incognito: ${tor ? 'ON' : 'OFF'}`;
            this.classList.toggle('tor-active', tor);
            toast('Incognito ' + (tor ? 'on' : 'off'), 'info');
        };

        // PANELS
        document.getElementById('historyBtn').onclick = () => document.getElementById('histPanel').classList.add('open');
        document.getElementById('closeHist').onclick = () => document.getElementById('histPanel').classList.remove('open');
        document.getElementById('contactBtn').onclick = () => document.getElementById('contactPanel').classList.add('open');
        document.getElementById('closeContact').onclick = () => document.getElementById('contactPanel').classList.remove('open');
        document.getElementById('globalBtn').onclick = () => document.getElementById('globalPanel').classList.add('open');
        document.getElementById('closeGlobal').onclick = () => document.getElementById('globalPanel').classList.remove('open');

        document.getElementById('clearBtn').onclick = function() {
            document.getElementById('chatBox').innerHTML = '<div class="message message-ai"><div class="message-text">Chat cleared.</div></div>';
            toast('Cleared', 'success');
        };

        // HISTORY
        async function loadHist() {
            if (!user) return;
            try {
                const sn = await getDocs(query(collection(db, 'artifacts', 'virza-v12', 'users', user.uid, 'history'), orderBy('timestamp', 'desc'), limit(25)));
                document.getElementById('histList').innerHTML = '';
                sn.forEach(d => {
                    const dt = d.data();
                    const tm = dt.timestamp?.toDate?.() || new Date();
                    const it = document.createElement('div');
                    it.className = 'history-item';
                    it.innerHTML = `<div style="font-size:0.45rem;color:var(--accent)">${dt.portal || 'General'}</div><div style="font-size:0.65rem">${dt.prompt}</div><div style="font-size:0.4rem;color:#64748b">${tm.toLocaleString('id-ID')}</div>`;
                    it.onclick = () => { document.getElementById('chatInput').value = dt.prompt; document.getElementById('histPanel').classList.remove('open'); };
                    document.getElementById('histList').appendChild(it);
                });
            } catch { }
        }

        // GLOBAL CHAT
        function initGlobal() {
            if (!user) return;
            const q = query(collection(db, 'chatrooms', 'global', 'messages'), orderBy('timestamp', 'asc'), limit(50));
            onSnapshot(q, snap => {
                const box = document.getElementById('globalBox');
                box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const div = document.createElement('div');
                    div.className = 'global-msg ' + (m.uid === user.uid ? 'self' : 'other');
                    div.innerHTML = `<div style="font-size:0.45rem;opacity:0.7">${m.name || 'Anon'}</div><div>${m.text}</div>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendGlobal').onclick = async function() {
            const txt = document.getElementById('globalInput').value.trim();
            if (!txt || !user) return;
            await addDoc(collection(db, 'chatrooms', 'global', 'messages'), {
                text: txt,
                uid: user.uid,
                name: user.displayName || user.email?.split('@')[0] || 'Ghost',
                timestamp: serverTimestamp()
            });
            document.getElementById('globalInput').value = '';
        };

        document.getElementById('globalInput').onkeydown = e => { if (e.key === 'Enter') document.getElementById('sendGlobal').click(); };

        // Close attach menu on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('.attachment-btn')) {
                document.getElementById('attachMenu').classList.remove('show');
            }
        });

        // Auto proxy refresh
        setTimeout(() => document.getElementById('refreshProxyBtn').click(), 3500);
        setInterval(() => document.getElementById('refreshProxyBtn').click(), 1800000);
    </script>
</body>
</html>
